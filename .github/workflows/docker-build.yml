name: æ„å»ºå’Œæ¨é€Dockeré•œåƒ

on:
  workflow_dispatch:
    inputs:
      build_platforms:
        description: 'æ„å»ºå¹³å°'
        required: true
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
        - 'linux/amd64'
        - 'linux/arm64'
        - 'linux/amd64,linux/arm64'
      install_warp:
        description: 'æ˜¯å¦å®‰è£… WARP'
        required: true
        default: false
        type: boolean
      push_image:
        description: 'æ˜¯å¦æ¨é€é•œåƒ'
        required: true
        default: true
        type: boolean
      run_tests:
        description: 'æ˜¯å¦è¿è¡Œæµ‹è¯•'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}${{ inputs.install_warp && '-warp' || '' }}

jobs:
  build:
    name: ğŸ—ï¸ æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      if: ${{ inputs.push_image }}
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest
          type=raw,value={{date 'YYYYMMDD-HHmmss'}}

    - name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ inputs.build_platforms }}
        push: ${{ inputs.push_image }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

        build-args: |
          INSTALL_WARP=${{ inputs.install_warp }}
          BUILDTIME=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}

    - name: ğŸ“Š è¾“å‡ºæ„å»ºä¿¡æ¯
      run: |
        echo "ğŸ¯ æ„å»ºå¹³å°: ${{ inputs.build_platforms }}"
        echo "ğŸŒ WARP æ”¯æŒ: ${{ inputs.install_warp && 'æ˜¯' || 'å¦' }}"
        echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
        echo "ğŸš€ æ¨é€çŠ¶æ€: ${{ inputs.push_image }}"

  test:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Basic syntax check
      run: |
        python -m py_compile main.py
        python -c "import core; print('âœ… Core module import successful')"
        python -c "import modules; print('âœ… Modules import successful')"
        python -c "import web; print('âœ… Web module import successful')"
        python -c "import api; print('âœ… API module import successful')"

  container-test:
    name: ğŸ§ª å®¹å™¨åŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.run_tests }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ æ„å»ºæµ‹è¯•é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: yt-dlp-web-v2:test

        build-args: |
          INSTALL_WARP=${{ inputs.install_warp }}

    - name: ğŸŒ åˆ›å»ºæµ‹è¯•ç½‘ç»œ
      run: docker network create yt-dlp-test

    - name: ğŸ§ª è¿è¡Œå®¹å™¨æµ‹è¯•
      run: |
        # ğŸš€ å¯åŠ¨æµ‹è¯•å®¹å™¨
        echo "ğŸš€ å¯åŠ¨æµ‹è¯•å®¹å™¨..."

        # æ ¹æ®æ˜¯å¦å®‰è£… WARP å†³å®šå¯åŠ¨å‚æ•°
        if [[ "${{ inputs.install_warp }}" == "true" ]]; then
          echo "ğŸ“‹ å¯åŠ¨ WARP ç‰ˆæœ¬æµ‹è¯•å®¹å™¨ï¼ˆç¦ç”¨ WARP ä»¥é¿å…æµ‹è¯•ç¯å¢ƒé—®é¢˜ï¼‰..."
          docker run -d \
            --name yt-dlp-test \
            --network yt-dlp-test \
            --cap-add NET_ADMIN \
            --sysctl net.ipv4.ip_forward=1 \
            --sysctl net.ipv4.conf.all.src_valid_mark=1 \
            --sysctl net.ipv6.conf.all.disable_ipv6=0 \
            --sysctl net.ipv6.conf.all.forwarding=1 \
            -p 8080:8080 \
            -e SECRET_KEY=test-secret-key \
            -e DATABASE_URL=sqlite:///data/test.db \
            -e ENABLE_WARP=false \
            -v /tmp/yt-dlp-test:/app/downloads \
            yt-dlp-web-v2:test
        else
          echo "ğŸ“‹ å¯åŠ¨æ ‡å‡†ç‰ˆæµ‹è¯•å®¹å™¨..."
          docker run -d \
            --name yt-dlp-test \
            --network yt-dlp-test \
            -p 8080:8080 \
            -e SECRET_KEY=test-secret-key \
            -e DATABASE_URL=sqlite:///data/test.db \
            -v /tmp/yt-dlp-test:/app/downloads \
            yt-dlp-web-v2:test
        fi

        # â³ ç­‰å¾…å®¹å™¨å¯åŠ¨
        if [[ "${{ inputs.install_warp }}" == "true" ]]; then
          echo "â³ ç­‰å¾… WARP ç‰ˆæœ¬å®¹å™¨å¯åŠ¨ï¼ˆéœ€è¦æ›´é•¿æ—¶é—´ï¼‰..."
          sleep 60
        else
          echo "â³ ç­‰å¾…æ ‡å‡†ç‰ˆå®¹å™¨å¯åŠ¨..."
          sleep 30
        fi

        # ğŸ“Š æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if ! docker ps | grep yt-dlp-test; then
          echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
          echo "ğŸ“‹ å®¹å™¨æ—¥å¿—ï¼š"
          docker logs yt-dlp-test
          exit 1
        fi
        echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ"

        # ğŸ” å¥åº·æ£€æŸ¥
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        for i in {1..10}; do
          if curl -f http://localhost:8080/api/health; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          fi
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/10)"
          sleep 10
          if [ $i -eq 10 ]; then
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            echo "ğŸ“‹ å®¹å™¨æ—¥å¿—ï¼š"
            docker logs yt-dlp-test
            exit 1
          fi
        done

        # ğŸ§ª åŠŸèƒ½æµ‹è¯•
        echo "ğŸ§ª æ‰§è¡ŒåŠŸèƒ½æµ‹è¯•..."

        # æµ‹è¯•é¦–é¡µè®¿é—®
        echo "ğŸ  æµ‹è¯•é¦–é¡µè®¿é—®..."
        if curl -f http://localhost:8080/; then
          echo "âœ… é¦–é¡µè®¿é—®æ­£å¸¸"
        else
          echo "âŒ é¦–é¡µè®¿é—®å¤±è´¥"
          exit 1
        fi

        # æµ‹è¯•APIæ¥å£ (ä½¿ç”¨æ— éœ€è®¤è¯çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹)
        echo "ğŸ”Œ æµ‹è¯•APIæ¥å£..."
        if curl -f http://localhost:8080/api/health; then
          echo "âœ… APIæ¥å£æ­£å¸¸"
        else
          echo "âŒ APIæ¥å£å¤±è´¥"
          exit 1
        fi

        # æµ‹è¯•é™æ€æ–‡ä»¶
        echo "ğŸ“ æµ‹è¯•é™æ€æ–‡ä»¶æœåŠ¡..."
        if curl -f http://localhost:8080/static/ || curl -I http://localhost:8080/static/; then
          echo "âœ… é™æ€æ–‡ä»¶æœåŠ¡æ­£å¸¸"
        else
          echo "âš ï¸ é™æ€æ–‡ä»¶æœåŠ¡å¯èƒ½æœ‰é—®é¢˜ï¼ˆéè‡´å‘½ï¼‰"
        fi

        # æµ‹è¯•æ•°æ®åº“è¿æ¥ (é€šè¿‡å¥åº·æ£€æŸ¥ç«¯ç‚¹)
        echo "ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“è¿æ¥..."
        if curl -s http://localhost:8080/api/health | grep -q "database"; then
          echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
        else
          echo "âš ï¸ æ•°æ®åº“è¿æ¥æµ‹è¯•è·³è¿‡ï¼ˆéè‡´å‘½ï¼‰"
        fi

        echo "ğŸ‰ æ‰€æœ‰å®¹å™¨æµ‹è¯•é€šè¿‡ï¼"

    - name: ğŸ§¹ æ¸…ç†æµ‹è¯•å®¹å™¨
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ..."
        docker stop yt-dlp-test || true
        docker rm yt-dlp-test || true
        docker network rm yt-dlp-test || true
        docker rmi yt-dlp-web-v2:test || true
        echo "âœ… æ¸…ç†å®Œæˆ"

  security-scan:
    name: ğŸ”’ å®‰å…¨æ¼æ´æ‰«æ
    runs-on: ubuntu-latest
    needs: [build, container-test]
    if: ${{ inputs.push_image && always() && !failure() }}

    steps:
    - name: ğŸ” è¿è¡ŒTrivyæ¼æ´æ‰«æå™¨
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“¤ ä¸Šä¼ æ‰«æç»“æœåˆ°GitHubå®‰å…¨é€‰é¡¹å¡
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: ğŸ“Š è¾“å‡ºæ‰«ææ‘˜è¦
      run: |
        echo "ğŸ”’ å®‰å…¨æ‰«æå®Œæˆ"
        echo "ğŸ“‹ æ‰«æç»“æœå·²ä¸Šä¼ åˆ°GitHub Securityé€‰é¡¹å¡"

  build-summary:
    name: ğŸ“Š æ„å»ºæ‘˜è¦
    runs-on: ubuntu-latest
    needs: [build, container-test]
    if: always()

    steps:
    - name: ğŸ“‹ è¾“å‡ºæ„å»ºæ‘˜è¦
      run: |
        echo "ğŸ¯ æ„å»ºå¹³å°: ${{ inputs.build_platforms }}"
        echo "ğŸŒ WARP æ”¯æŒ: ${{ inputs.install_warp && 'æ˜¯' || 'å¦' }}"
        echo "ğŸš€ æ¨é€çŠ¶æ€: ${{ inputs.push_image }}"
        echo "ğŸ§ª æµ‹è¯•çŠ¶æ€: ${{ inputs.run_tests }}"
        echo ""
        echo "ğŸ“¦ æ„å»ºç»“æœ:"

        if [[ "${{ needs.build.result }}" == "success" ]]; then
          echo "âœ… é•œåƒæ„å»ºæˆåŠŸ"
        else
          echo "âŒ é•œåƒæ„å»ºå¤±è´¥"
        fi

        echo ""
        echo "ğŸ§ª æµ‹è¯•ç»“æœ:"

        if [[ "${{ inputs.run_tests }}" == "true" ]]; then
          if [[ "${{ needs.container-test.result }}" == "success" ]]; then
            echo "âœ… å®¹å™¨æµ‹è¯•é€šè¿‡"
          else
            echo "âŒ å®¹å™¨æµ‹è¯•å¤±è´¥"
          fi
        else
          echo "â­ï¸ æµ‹è¯•å·²è·³è¿‡"
        fi
