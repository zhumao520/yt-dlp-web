{% extends "base_modern.html" %}

{% block title %}ä¸‹è½½å†å²ä¸­å¿ƒ - YT-DLP Web{% endblock %}

{% block content %}
<div class="container-fluid" id="historyApp">
    
    <!-- ğŸ¨ ç°ä»£åŒ–é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-3">
        <div class="col">
            <div class="text-center animate-fade-in-up">
                <h1 class="display-5 fw-bold text-gradient mb-2">
                    <i class="bi bi-clock-history me-3"></i>ä¸‹è½½å†å²ä¸­å¿ƒ
                </h1>
                <p class="lead text-muted mb-3">
                    æŸ¥çœ‹æ‰€æœ‰ä¸‹è½½è®°å½•ã€çŠ¶æ€å’Œè¯¦ç»†ä¿¡æ¯
                </p>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                    <span class="badge rounded-pill px-3 py-2" style="background: var(--gradient-primary); color: white;">
                        <i class="bi bi-list-check me-1"></i>è®°å½•ç®¡ç†
                    </span>
                    <span class="badge rounded-pill px-3 py-2" style="background: var(--gradient-success); color: white;">
                        <i class="bi bi-search me-1"></i>æ™ºèƒ½æœç´¢
                    </span>
                    <span class="badge rounded-pill px-3 py-2" style="background: var(--gradient-warning); color: white;">
                        <i class="bi bi-funnel me-1"></i>çŠ¶æ€è¿‡æ»¤
                    </span>
                    <span class="badge rounded-pill px-3 py-2" style="background: var(--gradient-danger); color: white;">
                        <i class="bi bi-arrow-repeat me-1"></i>é‡æ–°ä¸‹è½½
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ğŸ“Š ç°ä»£åŒ–ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-3">
        <div class="col-lg-8 mx-auto">
            <div class="row">
                <div class="col-6 col-md-3 mb-2">
            <div class="modern-card p-4 text-center h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="text-white">
                    <i class="bi bi-list-ul display-6 mb-2"></i>
                    <h4 class="fw-bold mb-1" id="totalCount">0</h4>
                    <p class="mb-0 opacity-75">æ€»ä¸‹è½½æ•°</p>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-3 mb-2">
            <div class="modern-card p-4 text-center h-100" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="text-white">
                    <i class="bi bi-check-circle display-6 mb-2"></i>
                    <h4 class="fw-bold mb-1" id="completedCount">0</h4>
                    <p class="mb-0 opacity-75">æˆåŠŸ</p>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-3 mb-2">
            <div class="modern-card p-4 text-center h-100" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <div class="text-white">
                    <i class="bi bi-clock display-6 mb-2"></i>
                    <h4 class="fw-bold mb-1" id="activeCount">0</h4>
                    <p class="mb-0 opacity-75">è¿›è¡Œä¸­</p>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-3 mb-2">
            <div class="modern-card p-4 text-center h-100" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <div class="text-white">
                    <i class="bi bi-x-circle display-6 mb-2"></i>
                    <h4 class="fw-bold mb-1" id="failedCount">0</h4>
                    <p class="mb-0 opacity-75">å¤±è´¥</p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- ğŸ› ï¸ ç°ä»£åŒ–è¿‡æ»¤å’Œæœç´¢ -->
    <div class="row mb-3">
        <div class="col-lg-8 mx-auto">
            <div class="modern-card p-3">
                <div class="row g-3 align-items-center">
                    <!-- ğŸ” æœç´¢ -->
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-primary text-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text"
                                   class="form-control modern-input"
                                   id="searchInput"
                                   placeholder="æœç´¢æ ‡é¢˜æˆ–URL...">
                        </div>
                    </div>

                    <!-- ğŸ“Š çŠ¶æ€è¿‡æ»¤ -->
                    <div class="col-md-2">
                        <select class="form-select modern-input" id="statusFilter">
                            <option value="all">ğŸ“‹ æ‰€æœ‰çŠ¶æ€</option>
                            <option value="completed">âœ… å·²å®Œæˆ</option>
                            <option value="downloading">â¬‡ï¸ ä¸‹è½½ä¸­</option>
                            <option value="pending">â³ ç­‰å¾…ä¸­</option>
                            <option value="failed">âŒ å¤±è´¥</option>
                            <option value="cancelled">ğŸš« å·²å–æ¶ˆ</option>
                        </select>
                    </div>

                    <!-- ğŸŒ æ¥æºè¿‡æ»¤ -->
                    <div class="col-md-2">
                        <select class="form-select modern-input" id="sourceFilter">
                            <option value="all">ğŸŒ æ‰€æœ‰æ¥æº</option>
                            <option value="web_interface">ğŸ’» ç½‘é¡µç•Œé¢</option>
                            <option value="telegram_webhook">ğŸ¤– Telegramæœºå™¨äºº</option>
                            <option value="api">ğŸ”Œ APIæ¥å£</option>
                        </select>
                    </div>

                    <!-- ğŸ›ï¸ æ“ä½œæŒ‰é’® -->
                    <div class="col-md-4">
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-primary modern-btn" id="refreshBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
                            </button>
                            <button type="button" class="btn btn-outline-danger modern-btn" id="clearHistoryBtn">
                                <i class="bi bi-trash me-1"></i>æ¸…ç©ºå†å²
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¸‹è½½åˆ—è¡¨ -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div id="downloadsList">
                <!-- ä¸‹è½½è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyState" class="modern-card d-none">
                <div class="p-4 text-center py-5">
                    <i class="bi bi-inbox display-4 text-white opacity-50"></i>
                    <h5 class="mt-3 text-white">æš‚æ— ä¸‹è½½è®°å½•</h5>
                    <p class="text-white opacity-75" id="emptyMessage">è¿˜æ²¡æœ‰ä»»ä½•ä¸‹è½½è®°å½•</p>
                </div>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-2 text-muted">åŠ è½½ä¸‹è½½å†å²...</p>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script>
class HistoryApp {
    constructor() {
        this.downloads = [];
        this.filteredDownloads = [];
        this.searchQuery = '';
        this.statusFilter = 'all';
        this.sourceFilter = 'all';
        this.stats = {
            total: 0,
            completed: 0,
            active: 0,
            failed: 0
        };
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadHistory();
        this.startPolling();
    }
    
    bindEvents() {
        // æœç´¢
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.searchQuery = e.target.value;
            this.filterDownloads();
        });
        
        // çŠ¶æ€è¿‡æ»¤
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            this.statusFilter = e.target.value;
            this.filterDownloads();
        });
        
        // æ¥æºè¿‡æ»¤
        document.getElementById('sourceFilter').addEventListener('change', (e) => {
            this.sourceFilter = e.target.value;
            this.filterDownloads();
        });
        
        // åˆ·æ–°æŒ‰é’®
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.refreshHistory();
        });
        
        // æ¸…ç©ºå†å²æŒ‰é’®
        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            this.clearHistory();
        });
    }
    
    async loadHistory() {
        this.showLoading(true);
        
        try {
            const response = await apiRequest('/api/download/list');
            if (response.ok) {
                const data = await response.json();
                this.downloads = data.downloads || [];
                this.calculateStats();
                this.filterDownloads();
            } else {
                showNotification('åŠ è½½ä¸‹è½½å†å²å¤±è´¥', 'danger');
            }
        } catch (error) {
            console.error('åŠ è½½ä¸‹è½½å†å²å¤±è´¥:', error);
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        } finally {
            this.showLoading(false);
        }
    }
    
    calculateStats() {
        this.stats = {
            total: this.downloads.length,
            completed: this.downloads.filter(d => d.status === 'completed').length,
            active: this.downloads.filter(d => ['pending', 'downloading'].includes(d.status)).length,
            failed: this.downloads.filter(d => d.status === 'failed').length
        };
        
        document.getElementById('totalCount').textContent = this.stats.total;
        document.getElementById('completedCount').textContent = this.stats.completed;
        document.getElementById('activeCount').textContent = this.stats.active;
        document.getElementById('failedCount').textContent = this.stats.failed;
    }
    
    filterDownloads() {
        let filtered = [...this.downloads];
        
        // æœç´¢è¿‡æ»¤
        if (this.searchQuery) {
            const query = this.searchQuery.toLowerCase();
            filtered = filtered.filter(download => 
                (download.title && download.title.toLowerCase().includes(query)) ||
                download.url.toLowerCase().includes(query)
            );
        }
        
        // çŠ¶æ€è¿‡æ»¤
        if (this.statusFilter !== 'all') {
            filtered = filtered.filter(download => download.status === this.statusFilter);
        }
        
        // æ¥æºè¿‡æ»¤
        if (this.sourceFilter !== 'all') {
            filtered = filtered.filter(download => 
                download.options?.source === this.sourceFilter
            );
        }
        
        this.filteredDownloads = filtered;
        this.renderDownloads();
    }
    
    renderDownloads() {
        const container = document.getElementById('downloadsList');
        const emptyState = document.getElementById('emptyState');
        
        if (this.filteredDownloads.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('d-none');
            document.getElementById('emptyMessage').textContent = 
                this.searchQuery || this.statusFilter !== 'all' || this.sourceFilter !== 'all' 
                    ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¸‹è½½è®°å½•' 
                    : 'è¿˜æ²¡æœ‰ä»»ä½•ä¸‹è½½è®°å½•';
            return;
        }
        
        emptyState.classList.add('d-none');
        
        container.innerHTML = this.filteredDownloads.map(download => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-start">
                        <div class="col-md-8">
                            <!-- æ ‡é¢˜å’ŒURL -->
                            <div class="mb-2">
                                <h6 class="card-title mb-1">${this.escapeHtml(download.title || 'è·å–ä¿¡æ¯ä¸­...')}</h6>
                                <small class="text-muted text-break">${this.escapeHtml(download.url)}</small>
                            </div>
                            
                            <!-- è¿›åº¦æ¡ -->
                            ${download.status === 'downloading' ? `
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-muted">ä¸‹è½½è¿›åº¦</small>
                                        <small class="fw-medium">${download.progress}%</small>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar" style="width: ${download.progress}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- æ–‡ä»¶ä¿¡æ¯ -->
                            ${download.status === 'completed' && download.filename ? `
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-file-earmark me-1"></i>
                                        ${this.escapeHtml(download.filename)}
                                        ${download.file_size ? `(${this.formatSize(download.file_size)})` : ''}
                                    </small>
                                </div>
                            ` : ''}
                            
                            <!-- é”™è¯¯ä¿¡æ¯ -->
                            ${download.status === 'failed' && download.error_message ? `
                                <div class="alert alert-danger alert-sm mb-2">
                                    <i class="bi bi-exclamation-circle me-1"></i>
                                    <small>${this.escapeHtml(download.error_message)}</small>
                                </div>
                            ` : ''}
                            
                            <!-- å…ƒä¿¡æ¯ -->
                            <div class="d-flex flex-wrap gap-3">
                                <small class="text-muted">ID: <code>${download.id}</code></small>
                                <small class="text-muted">åˆ›å»º: ${this.formatDate(download.created_at)}</small>
                                ${download.completed_at ? `<small class="text-muted">å®Œæˆ: ${this.formatDate(download.completed_at)}</small>` : ''}
                                ${download.options?.source ? `<small class="text-muted">æ¥æº: ${this.getSourceName(download.options.source)}</small>` : ''}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="d-flex justify-content-end align-items-start gap-2">
                                <!-- çŠ¶æ€æ ‡ç­¾ -->
                                <span class="badge ${this.getStatusClass(download.status)}">${this.getStatusText(download.status)}</span>
                                
                                <!-- æ“ä½œæŒ‰é’® -->
                                <div class="btn-group btn-group-sm">
                                    ${download.status === 'completed' && download.filename ? 
                                        `<button class="btn btn-outline-primary" onclick="app.downloadFile('${download.filename}')" title="ä¸‹è½½æ–‡ä»¶">
                                            <i class="bi bi-download"></i>
                                        </button>` : ''
                                    }
                                    ${download.status === 'failed' ? 
                                        `<button class="btn btn-outline-success" onclick="app.retryDownload('${download.url}')" title="é‡æ–°ä¸‹è½½">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>` : ''
                                    }
                                    ${download.status === 'downloading' ? 
                                        `<button class="btn btn-outline-danger" onclick="app.cancelDownload(${download.id})" title="å–æ¶ˆä¸‹è½½">
                                            <i class="bi bi-x"></i>
                                        </button>` : ''
                                    }
                                    <button class="btn btn-outline-secondary" onclick="app.deleteRecord(${download.id})" title="åˆ é™¤è®°å½•">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    showLoading(show) {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const container = document.getElementById('downloadsList');
        
        if (show) {
            loadingState.classList.remove('d-none');
            emptyState.classList.add('d-none');
            container.innerHTML = '';
        } else {
            loadingState.classList.add('d-none');
        }
    }
    
    async refreshHistory() {
        await this.loadHistory();
        showNotification('å†å²è®°å½•å·²åˆ·æ–°', 'success');
    }
    
    async clearHistory() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸‹è½½å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        
        try {
            // è¿™é‡Œéœ€è¦å®ç°æ¸…ç©ºå†å²çš„API
            showNotification('å†å²è®°å½•æ¸…ç©ºåŠŸèƒ½å¾…å®ç°', 'warning');
        } catch (error) {
            showNotification('æ¸…ç©ºå†å²å¤±è´¥', 'danger');
        }
    }
    
    async retryDownload(url) {
        try {
            const response = await apiRequest('/api/download/start', {
                method: 'POST',
                body: JSON.stringify({ url })
            });
            
            if (response.ok) {
                showNotification('é‡æ–°ä¸‹è½½å·²å¼€å§‹', 'success');
                await this.loadHistory();
            } else {
                showNotification('é‡æ–°ä¸‹è½½å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }
    
    async cancelDownload(downloadId) {
        try {
            const response = await apiRequest(`/api/download/cancel/${downloadId}`, {
                method: 'POST'
            });
            
            if (response.ok) {
                showNotification('ä¸‹è½½å·²å–æ¶ˆ', 'success');
                await this.loadHistory();
            } else {
                showNotification('å–æ¶ˆä¸‹è½½å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }
    
    async deleteRecord(downloadId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ä¸‹è½½è®°å½•å—ï¼Ÿ')) return;
        
        try {
            // è¿™é‡Œéœ€è¦å®ç°åˆ é™¤è®°å½•çš„API
            showNotification('åˆ é™¤è®°å½•åŠŸèƒ½å¾…å®ç°', 'warning');
        } catch (error) {
            showNotification('åˆ é™¤è®°å½•å¤±è´¥', 'danger');
        }
    }
    
    downloadFile(filename) {
        window.open(`/files/download/${encodeURIComponent(filename)}`, '_blank');
    }
    
    startPolling() {
        setInterval(async () => {
            if (this.stats.active > 0) {
                await this.loadHistory();
            }
        }, 3000);
    }
    
    // çŠ¶æ€å¤„ç†
    getStatusClass(status) {
        const classes = {
            'pending': 'bg-warning',
            'downloading': 'bg-primary',
            'completed': 'bg-success',
            'failed': 'bg-danger',
            'cancelled': 'bg-secondary'
        };
        return classes[status] || classes['pending'];
    }

    getStatusText(status) {
        const texts = {
            'pending': 'ç­‰å¾…ä¸­',
            'downloading': 'ä¸‹è½½ä¸­',
            'completed': 'å·²å®Œæˆ',
            'failed': 'å¤±è´¥',
            'cancelled': 'å·²å–æ¶ˆ'
        };
        return texts[status] || 'æœªçŸ¥';
    }
    
    getSourceName(source) {
        const names = {
            'web_interface': 'ç½‘é¡µç•Œé¢',
            'telegram_webhook': 'Telegramæœºå™¨äºº',
            'api': 'APIæ¥å£'
        };
        return names[source] || source;
    }
    
    // æ ¼å¼åŒ–å‡½æ•°
    formatSize(bytes) {
        if (!bytes) return '';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    formatDate(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toLocaleString('zh-CN');
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// åˆå§‹åŒ–åº”ç”¨
let app;
document.addEventListener('DOMContentLoaded', function() {
    app = new HistoryApp();
});
</script>
{% endblock %}
