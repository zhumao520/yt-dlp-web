{% extends "base_modern.html" %}

{% block title %}è®¾ç½® - YT-DLP Web{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h2 class="mb-4">
                <i class="bi bi-gear me-2 text-primary"></i>ç³»ç»Ÿè®¾ç½®
            </h2>

    <!-- ç®€æ´çš„é€‰é¡¹å¡è®¾è®¡ - å¼ºåˆ¶å†…è”æ ·å¼ -->
    <div style="background: var(--bg-primary); border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; margin: 0; padding: 0;">
        <!-- é€‰é¡¹å¡æŒ‰é’® -->
        <div style="display: flex; background: var(--bg-secondary); margin: 0; padding: 0; border-bottom: 1px solid var(--border-color);">
            <button class="settings-tab active" data-target="general" style="flex: 1; padding: 1rem; background: var(--bg-primary); border: none; cursor: pointer; font-weight: 500; color: #0d6efd; border-bottom: 2px solid #0d6efd; margin: 0;">
                <i class="bi bi-gear me-2"></i>åŸºç¡€è®¾ç½®
            </button>
            <button class="settings-tab" data-target="download" style="flex: 1; padding: 1rem; background: none; border: none; cursor: pointer; font-weight: 500; color: var(--text-secondary); margin: 0;">
                <i class="bi bi-download me-2"></i>ä¸‹è½½é…ç½®
            </button>
            <button class="settings-tab" data-target="security" style="flex: 1; padding: 1rem; background: none; border: none; cursor: pointer; font-weight: 500; color: var(--text-secondary); margin: 0;">
                <i class="bi bi-shield me-2"></i>å®‰å…¨è®¾ç½®
            </button>
            <button class="settings-tab" data-target="shortcuts" style="flex: 1; padding: 1rem; background: none; border: none; cursor: pointer; font-weight: 500; color: var(--text-secondary); margin: 0;">
                <i class="bi bi-phone me-2"></i>iOSå¿«æ·æŒ‡ä»¤
            </button>
            <button class="settings-tab" data-target="advanced" style="flex: 1; padding: 1rem; background: none; border: none; cursor: pointer; font-weight: 500; color: var(--text-secondary); margin: 0;">
                <i class="bi bi-lightning me-2"></i>é«˜çº§åŠŸèƒ½
            </button>
        </div>

        <!-- é€‰é¡¹å¡å†…å®¹ -->
        <div style="padding: 1.5rem; background: var(--bg-primary); margin: 0;">
            <!-- åŸºç¡€è®¾ç½® -->
            <div class="settings-panel active" id="general">
                <h5 class="mb-3 fw-bold">
                    <i class="bi bi-gear me-2 text-primary"></i>åŸºç¡€è®¾ç½®
                </h5>
                <form id="generalForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="appName" class="form-label fw-bold">
                                <i class="bi bi-app me-1 text-primary"></i>åº”ç”¨åç§°
                            </label>
                            <input type="text" class="form-control modern-input" id="appName" value="YT-DLP Web">
                        </div>
                        <div class="col-md-6">
                            <label for="sessionTimeout" class="form-label fw-bold">
                                <i class="bi bi-clock me-1 text-success"></i>ä¼šè¯è¶…æ—¶ (å°æ—¶)
                            </label>
                            <input type="number" class="form-control modern-input" id="sessionTimeout" value="24" min="1" max="168">
                        </div>
                        <div class="col-12">
                            <label for="secretKey" class="form-label fw-bold">
                                <i class="bi bi-key me-1 text-warning"></i>åº”ç”¨å¯†é’¥
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control modern-input" id="secretKey" placeholder="ç‚¹å‡»ç”Ÿæˆæ–°å¯†é’¥" autocomplete="new-password">
                                <button type="button" class="btn btn-outline-secondary modern-btn" id="toggleSecretKey">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary modern-btn" id="generateSecretKey">
                                    ç”Ÿæˆæ–°å¯†é’¥
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>ç”¨äºä¼šè¯åŠ å¯†ï¼Œä¿®æ”¹åæ‰€æœ‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="debugMode">
                                <label class="form-check-label" for="debugMode">
                                    å¯ç”¨è°ƒè¯•æ¨¡å¼
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary modern-btn py-3 px-5"
                                    style="background: var(--gradient-primary); border: none; font-size: 1.1rem;">
                                <i class="bi bi-check-lg me-2"></i>ä¿å­˜åŸºç¡€è®¾ç½®
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- ä¸‹è½½é…ç½® -->
            <div class="settings-panel" id="download">
                <h5 class="mb-3 fw-bold">
                    <i class="bi bi-download me-2 text-primary"></i>ä¸‹è½½é…ç½®
                </h5>
                <form id="downloadForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="outputDir" class="form-label fw-bold">
                                <i class="bi bi-folder me-1 text-primary"></i>ä¸‹è½½ç›®å½•
                            </label>
                            <input type="text" class="form-control modern-input" id="outputDir" value="/downloads">
                        </div>
                        <div class="col-md-6">
                            <label for="maxConcurrent" class="form-label fw-bold">
                                <i class="bi bi-layers me-1 text-success"></i>æœ€å¤§å¹¶å‘ä¸‹è½½æ•°
                            </label>
                            <input type="number" class="form-control modern-input" id="maxConcurrent" value="3" min="1" max="10">
                        </div>
                        <div class="col-md-6">
                            <label for="downloadTimeout" class="form-label fw-bold">
                                <i class="bi bi-clock me-1 text-warning"></i>ä¸‹è½½è¶…æ—¶ (ç§’)
                            </label>
                            <input type="number" class="form-control modern-input" id="downloadTimeout" value="300" min="60" max="3600">
                        </div>
                        <div class="col-md-6">
                            <label for="defaultQuality" class="form-label fw-bold">
                                <i class="bi bi-badge-hd me-1 text-info"></i>é»˜è®¤è§†é¢‘è´¨é‡
                            </label>
                            <select class="form-select modern-input" id="defaultQuality">
                                <option value="best">ğŸ† æœ€é«˜è´¨é‡</option>
                                <option value="medium" selected>âš¡ ä¸­ç­‰è´¨é‡ (720p)</option>
                                <option value="low">ğŸ’¾ ä½è´¨é‡</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoCleanup">
                                <label class="form-check-label fw-bold" for="autoCleanup">
                                    <i class="bi bi-trash me-1 text-danger"></i>å¯ç”¨è‡ªåŠ¨æ¸…ç†
                                </label>
                            </div>
                        </div>
                        <div class="col-12" id="cleanupOptions" style="display: none;">
                            <div class="modern-card p-3" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-gear me-1 text-primary"></i>è‡ªåŠ¨æ¸…ç†é€‰é¡¹
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="fileRetention" class="form-label fw-bold">
                                            <i class="bi bi-clock-history me-1 text-warning"></i>æ–‡ä»¶ä¿ç•™æ—¶é—´ (å°æ—¶)
                                        </label>
                                        <input type="number" class="form-control modern-input" id="fileRetention" value="72" min="1" max="8760">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="cleanupInterval" class="form-label fw-bold">
                                            <i class="bi bi-arrow-repeat me-1 text-info"></i>æ¸…ç†é—´éš” (å°æ—¶)
                                        </label>
                                        <input type="number" class="form-control modern-input" id="cleanupInterval" value="6" min="1" max="168">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="maxStorage" class="form-label fw-bold">
                                            <i class="bi bi-hdd me-1 text-success"></i>æœ€å¤§å­˜å‚¨ç©ºé—´ (MB)
                                        </label>
                                        <input type="number" class="form-control modern-input" id="maxStorage" value="5000" min="100">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="keepRecentFiles" class="form-label fw-bold">
                                            <i class="bi bi-files me-1 text-primary"></i>ä¿ç•™æœ€è¿‘æ–‡ä»¶æ•°
                                        </label>
                                        <input type="number" class="form-control modern-input" id="keepRecentFiles" value="10" min="1" max="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary modern-btn py-3 px-5"
                                    style="background: var(--gradient-primary); border: none; font-size: 1.1rem;">
                                <i class="bi bi-check-lg me-2"></i>ä¿å­˜ä¸‹è½½é…ç½®
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- å®‰å…¨è®¾ç½® -->
            <div class="settings-panel" id="security">
                <div class="row g-3">
                    <!-- ä¿®æ”¹ç”¨æˆ·å -->
                    <div class="col-12">
                        <div class="modern-card p-4">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-person me-2 text-primary"></i>ä¿®æ”¹ç®¡ç†å‘˜ç”¨æˆ·å
                            </h5>
                            <form id="usernameForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="currentUsernamePassword" class="form-label fw-bold">
                                            <i class="bi bi-lock me-1 text-warning"></i>å½“å‰å¯†ç 
                                        </label>
                                        <input type="password" class="form-control modern-input" id="currentUsernamePassword" autocomplete="current-password" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="newUsername" class="form-label fw-bold">
                                            <i class="bi bi-person me-1 text-primary"></i>æ–°ç”¨æˆ·å
                                        </label>
                                        <input type="text" class="form-control modern-input" id="newUsername" autocomplete="username" minlength="3" required>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-warning modern-btn py-2 px-4">
                                            <i class="bi bi-person me-2"></i>ä¿®æ”¹ç”¨æˆ·å
                                        </button>
                                        <small class="text-muted ms-2">
                                            <i class="bi bi-info-circle me-1"></i>ä¿®æ”¹åéœ€è¦é‡æ–°ç™»å½•
                                        </small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ä¿®æ”¹å¯†ç  -->
                    <div class="col-12">
                        <div class="modern-card p-4">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-key me-2 text-primary"></i>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
                            </h5>
                            <form id="passwordForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="currentPassword" class="form-label fw-bold">
                                            <i class="bi bi-lock me-1 text-warning"></i>å½“å‰å¯†ç 
                                        </label>
                                        <input type="password" class="form-control modern-input" id="currentPassword" autocomplete="current-password" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="newPassword" class="form-label fw-bold">
                                            <i class="bi bi-key me-1 text-success"></i>æ–°å¯†ç 
                                        </label>
                                        <input type="password" class="form-control modern-input" id="newPassword" autocomplete="new-password" minlength="6" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="confirmPassword" class="form-label fw-bold">
                                            <i class="bi bi-shield-check me-1 text-info"></i>ç¡®è®¤æ–°å¯†ç 
                                        </label>
                                        <input type="password" class="form-control modern-input" id="confirmPassword" autocomplete="new-password" required>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary modern-btn py-2 px-4"
                                                style="background: var(--gradient-primary); border: none;">
                                            <i class="bi bi-key me-2"></i>ä¿®æ”¹å¯†ç 
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- APIè®¿é—®æ§åˆ¶ -->
                    <div class="col-12">
                        <div class="modern-card p-4">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-shield-check me-2 text-primary"></i>APIè®¿é—®æ§åˆ¶
                            </h5>
                            <form id="apiForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="apiEnabled">
                                            <label class="form-check-label fw-bold" for="apiEnabled">
                                                <i class="bi bi-toggle-on me-1 text-success"></i>å¯ç”¨APIè®¿é—®
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12" id="apiKeySection" style="display: none;">
                                        <label for="apiKey" class="form-label fw-bold">
                                            <i class="bi bi-key me-1 text-primary"></i>APIå¯†é’¥
                                        </label>
                                        <div class="input-group">
                                            <input type="text" class="form-control modern-input" id="apiKey" readonly>
                                            <button type="button" class="btn btn-outline-secondary modern-btn" id="generateApiKey">
                                                é‡æ–°ç”Ÿæˆ
                                            </button>
                                        </div>
                                        <div class="modern-card p-3 mt-3" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                                            <div class="text-white">
                                                <i class="bi bi-info-circle me-2"></i>
                                                æ­¤APIå¯†é’¥å¯ç”¨äºiOSå¿«æ·æŒ‡ä»¤ç­‰ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ä¸‹è½½æœåŠ¡
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary modern-btn py-2 px-4"
                                                style="background: var(--gradient-primary); border: none;">
                                            <i class="bi bi-check-lg me-2"></i>ä¿å­˜APIè®¾ç½®
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- iOSå¿«æ·æŒ‡ä»¤ -->
            <div class="settings-panel" id="shortcuts">
                <div class="modern-card p-4">
                    <h5 class="mb-3 fw-bold">
                        <i class="bi bi-phone me-2 text-primary"></i>iOSå¿«æ·æŒ‡ä»¤é›†æˆ
                    </h5>

                    <!-- æœåŠ¡çŠ¶æ€ -->
                    <div class="modern-card p-4 mb-4" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div class="d-flex text-white">
                            <i class="bi bi-check-circle me-3 mt-1"></i>
                            <div>
                                <h6 class="fw-bold">iOSå¿«æ·æŒ‡ä»¤APIå·²å°±ç»ª</h6>
                                <p class="mb-0">æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯é…ç½®iOSå¿«æ·æŒ‡ä»¤æ¥ä¸‹è½½è§†é¢‘</p>
                            </div>
                        </div>
                    </div>

                    <!-- APIé…ç½®ä¿¡æ¯ -->
                    <div class="mb-4">
                        <h6 class="mb-3">APIé…ç½®ä¿¡æ¯</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-server me-1 text-primary"></i>æœåŠ¡å™¨åœ°å€
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control modern-input" id="serverUrl" readonly>
                                    <button type="button" class="btn btn-outline-secondary modern-btn" onclick="copyToClipboard('serverUrl')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-link me-1 text-success"></i>ä¸‹è½½APIç«¯ç‚¹
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control modern-input" id="downloadEndpoint" readonly>
                                    <button type="button" class="btn btn-outline-secondary modern-btn" onclick="copyToClipboard('downloadEndpoint')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-12" id="apiKeySection2" style="display: none;">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-key me-1 text-warning"></i>APIå¯†é’¥
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control modern-input" id="apiKeyDisplay" readonly>
                                    <button type="button" class="btn btn-outline-secondary modern-btn" onclick="copyToClipboard('apiKeyDisplay')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>åœ¨å¿«æ·æŒ‡ä»¤ä¸­ä½¿ç”¨æ­¤APIå¯†é’¥è¿›è¡Œè®¤è¯
                                </div>
                            </div>
                            <div class="col-12" id="apiKeyWarning2">
                                <div class="modern-card p-3" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                    <div class="text-white">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        è¯·å…ˆåœ¨"å®‰å…¨è®¾ç½®"ä¸­å¯ç”¨APIè®¿é—®å¹¶ç”ŸæˆAPIå¯†é’¥
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é«˜çº§åŠŸèƒ½ -->
            <div class="settings-panel" id="advanced">
                <div class="modern-card p-4">
                    <h5 class="mb-3 fw-bold">
                        <i class="bi bi-lightning me-2 text-primary"></i>é«˜çº§åŠŸèƒ½
                    </h5>

                    <!-- å¼•æ“ç®¡ç† - ç´§å‡‘æ–¹å—å¸ƒå±€ -->
                    <div class="row g-2 mb-4">
                        <!-- yt-dlpç®¡ç† -->
                        <div class="col-md-6">
                            <div class="modern-card p-3" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); min-height: 200px; display: flex; flex-direction: column; justify-content: space-between;">
                                <div class="text-center text-white">
                                    <h6 class="mb-2 fw-bold">
                                        <i class="bi bi-youtube me-2"></i>yt-dlp ç®¡ç†
                                    </h6>
                                    <div class="mb-2">
                                        <strong>å½“å‰ç‰ˆæœ¬</strong>
                                        <div class="small" id="ytdlpVersion">æ£€æµ‹ä¸­...</div>
                                    </div>
                                </div>
                                <div class="d-grid gap-1">
                                    <button type="button" class="btn btn-outline-light btn-sm" id="checkYtdlpInfo">
                                        <i class="bi bi-info-circle me-1"></i>æ£€æŸ¥ä¿¡æ¯
                                    </button>
                                    <button type="button" class="btn btn-outline-light btn-sm" id="updateYtdlp">
                                        <i class="bi bi-download me-1"></i>æ›´æ–°
                                    </button>
                                    <button type="button" class="btn btn-outline-light btn-sm" id="installYtdlp">
                                        <i class="bi bi-box me-1"></i>é‡è£…
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- PyTubeFixç®¡ç† -->
                        <div class="col-md-6">
                            <div class="modern-card p-3" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); min-height: 200px; display: flex; flex-direction: column; justify-content: space-between;">
                                <div class="text-center text-white">
                                    <h6 class="mb-2 fw-bold">
                                        <i class="bi bi-play-circle me-2"></i>PyTubeFix ç®¡ç†
                                    </h6>
                                    <div class="mb-2">
                                        <strong>å½“å‰ç‰ˆæœ¬</strong>
                                        <div class="small" id="pytubefixVersion">æ£€æµ‹ä¸­...</div>
                                    </div>
                                </div>
                                <div class="d-grid gap-1">
                                    <button type="button" class="btn btn-outline-light btn-sm" id="checkPytubefixInfo">
                                        <i class="bi bi-info-circle me-1"></i>æ£€æŸ¥ä¿¡æ¯
                                    </button>
                                    <button type="button" class="btn btn-outline-light btn-sm" id="updatePytubefix">
                                        <i class="bi bi-download me-1"></i>æ›´æ–°
                                    </button>
                                    <button type="button" class="btn btn-outline-light btn-sm" id="installPytubefix">
                                        <i class="bi bi-box me-1"></i>é‡è£…
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç»Ÿä¸€å¼•æ“ç®¡ç† -->
                    <div class="mb-4">
                        <h6>å¼•æ“ç®¡ç†</h6>
                        <div class="modern-card p-4" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <div class="d-flex justify-content-between align-items-center text-white">
                                <div>
                                    <strong>åŒå¼•æ“ç³»ç»Ÿ</strong>
                                    <div class="small">yt-dlp + PyTubeFix åŒå¼•æ“å†—ä½™ä¸‹è½½</div>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-light btn-sm" id="checkAllEngines">
                                        <i class="bi bi-speedometer2"></i> æ£€æŸ¥çŠ¶æ€
                                    </button>
                                    <button type="button" class="btn btn-outline-light btn-sm" id="updateAllEngines">
                                        <i class="bi bi-arrow-repeat"></i> ä¸€é”®æ›´æ–°æ‰€æœ‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç³»ç»Ÿä¿¡æ¯ -->
                    <div class="mb-4">
                        <h6>ç³»ç»Ÿä¿¡æ¯</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                                    <div class="card-body">
                                        <h6 class="card-title">å­˜å‚¨ç©ºé—´</h6>
                                        <div id="storageInfo">
                                            <div class="d-flex justify-content-between">
                                                <span>å·²ç”¨ç©ºé—´:</span>
                                                <span id="usedSpace">è®¡ç®—ä¸­...</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>å¯ç”¨ç©ºé—´:</span>
                                                <span id="freeSpace">è®¡ç®—ä¸­...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                                    <div class="card-body">
                                        <h6 class="card-title">è¿è¡ŒçŠ¶æ€</h6>
                                        <div id="systemStatus">
                                            <div class="d-flex justify-content-between">
                                                <span>è¿è¡Œæ—¶é—´:</span>
                                                <span id="uptime">è®¡ç®—ä¸­...</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>æ´»è·ƒä¸‹è½½:</span>
                                                <span id="activeDownloads">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä»£ç†è®¾ç½® -->
                    <div class="mb-4">
                        <h6>ä»£ç†è®¾ç½®</h6>
                        <form id="proxyForm">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="proxyEnabled">
                                        <label class="form-check-label" for="proxyEnabled">
                                            å¯ç”¨ä»£ç†
                                        </label>
                                    </div>
                                    <div class="form-text">å¯ç”¨åï¼Œæ‰€æœ‰ä¸‹è½½è¯·æ±‚å°†é€šè¿‡ä»£ç†æœåŠ¡å™¨</div>
                                </div>
                            </div>

                            <div id="proxySettings" style="display: none;">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="proxyType" class="form-label">ä»£ç†ç±»å‹</label>
                                        <select class="form-select" id="proxyType">
                                            <option value="http">HTTP</option>
                                            <option value="https">HTTPS</option>
                                            <option value="socks4">SOCKS4</option>
                                            <option value="socks5">SOCKS5</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="proxyHost" class="form-label">ä»£ç†åœ°å€</label>
                                        <input type="text" class="form-control" id="proxyHost"
                                               placeholder="ä¾‹å¦‚: 127.0.0.1 æˆ– proxy.example.com">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="proxyPort" class="form-label">ç«¯å£</label>
                                        <input type="number" class="form-control" id="proxyPort"
                                               placeholder="8080" min="1" max="65535">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="proxyUsername" class="form-label">ç”¨æˆ·å <span class="text-muted">(å¯é€‰)</span></label>
                                        <input type="text" class="form-control" id="proxyUsername"
                                               placeholder="ä»£ç†è®¤è¯ç”¨æˆ·å">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="proxyPassword" class="form-label">å¯†ç  <span class="text-muted">(å¯é€‰)</span></label>
                                        <input type="password" class="form-control" id="proxyPassword"
                                               placeholder="ä»£ç†è®¤è¯å¯†ç " autocomplete="new-password">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <button type="button" class="btn btn-outline-primary" onclick="testProxy()">
                                            <i class="bi bi-wifi me-1"></i>æµ‹è¯•è¿æ¥
                                        </button>
                                        <span id="proxyTestResult" class="ms-2"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg me-1"></i>ä¿å­˜ä»£ç†è®¾ç½®
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- ç»´æŠ¤æ“ä½œ -->
                    <div>
                        <h6>ç»´æŠ¤æ“ä½œ</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-warning" id="cleanupFiles">
                                <i class="bi bi-trash"></i> æ¸…ç†æ–‡ä»¶
                            </button>
                            <button type="button" class="btn btn-outline-info" id="refreshSystem">
                                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°ç³»ç»Ÿ
                            </button>
                            <button type="button" class="btn btn-outline-danger" id="restartService">
                                <i class="bi bi-power"></i> é‡å¯æœåŠ¡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>
</div>

<script>
class SettingsApp {
    constructor() {
        this.settings = {
            general: {
                app_name: 'YT-DLP Web',
                session_timeout: 24,
                secret_key: '',
                debug_mode: false
            },
            download: {
                output_dir: '/downloads',
                max_concurrent: 3,
                timeout: 300,
                default_quality: 'medium',
                auto_cleanup: false,
                file_retention_hours: 72,
                cleanup_interval: 6,
                max_storage_mb: 5000,
                keep_recent_files: 10
            },
            security: {
                api_enabled: false,
                api_key: ''
            },
            proxy: {
                enabled: false,
                proxy_type: 'http',
                host: '',
                port: null,
                username: '',
                password: ''
            }
        };

        this.init();
    }

    init() {
        this.bindEvents();
        this.loadSettings();
        this.checkSystemInfo();
        this.updateShortcutInfo();
        this.initTabs();
    }

    initTabs() {
        const tabs = document.querySelectorAll('.settings-tab');
        const panels = document.querySelectorAll('.settings-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const target = this.getAttribute('data-target');

                // é‡ç½®æ‰€æœ‰é€‰é¡¹å¡æ ·å¼
                tabs.forEach(t => {
                    t.classList.remove('active');
                    t.style.background = 'none';
                    t.style.color = 'var(--text-secondary)';
                    t.style.borderBottom = 'none';
                });

                // éšè—æ‰€æœ‰é¢æ¿
                panels.forEach(p => p.classList.remove('active'));

                // æ¿€æ´»å½“å‰é€‰é¡¹å¡
                this.classList.add('active');
                this.style.background = 'var(--bg-primary)';
                this.style.color = '#0d6efd';
                this.style.borderBottom = '2px solid #0d6efd';

                // æ˜¾ç¤ºå¯¹åº”é¢æ¿
                document.getElementById(target).classList.add('active');
            });
        });
    }

    bindEvents() {
        // åŸºç¡€è®¾ç½®è¡¨å•
        document.getElementById('generalForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveGeneralSettings();
        });

        // ä¸‹è½½é…ç½®è¡¨å•
        document.getElementById('downloadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveDownloadSettings();
        });

        // ç”¨æˆ·åä¿®æ”¹è¡¨å•
        document.getElementById('usernameForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.changeUsername();
        });

        // å¯†ç ä¿®æ”¹è¡¨å•
        document.getElementById('passwordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.changePassword();
        });

        // APIè®¾ç½®è¡¨å•
        document.getElementById('apiForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveApiSettings();
        });

        // å¯†é’¥æ˜¾ç¤º/éšè—
        document.getElementById('toggleSecretKey').addEventListener('click', () => {
            this.toggleSecretKeyVisibility();
        });

        // ç”Ÿæˆå¯†é’¥
        document.getElementById('generateSecretKey').addEventListener('click', () => {
            this.generateSecretKey();
        });

        // è‡ªåŠ¨æ¸…ç†é€‰é¡¹
        document.getElementById('autoCleanup').addEventListener('change', (e) => {
            this.toggleCleanupOptions(e.target.checked);
        });

        // APIå¯ç”¨é€‰é¡¹
        document.getElementById('apiEnabled').addEventListener('change', (e) => {
            this.toggleApiKeySection(e.target.checked);
        });

        // ç”ŸæˆAPIå¯†é’¥
        document.getElementById('generateApiKey').addEventListener('click', () => {
            this.generateApiKey();
        });

        // ä»£ç†è®¾ç½®è¡¨å•
        document.getElementById('proxyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveProxySettings();
        });

        // ä»£ç†å¯ç”¨é€‰é¡¹
        document.getElementById('proxyEnabled').addEventListener('change', (e) => {
            this.toggleProxySettings(e.target.checked);
        });

        // yt-dlpç®¡ç†
        document.getElementById('checkYtdlpInfo').addEventListener('click', () => {
            this.checkYtdlpInfo();
        });

        document.getElementById('updateYtdlp').addEventListener('click', () => {
            this.updateYtdlp();
        });

        document.getElementById('installYtdlp').addEventListener('click', () => {
            this.installYtdlp();
        });

        // PyTubeFixç®¡ç†
        document.getElementById('checkPytubefixInfo').addEventListener('click', () => {
            this.checkPytubefixInfo();
        });

        document.getElementById('updatePytubefix').addEventListener('click', () => {
            this.updatePytubefix();
        });

        document.getElementById('installPytubefix').addEventListener('click', () => {
            this.installPytubefix();
        });

        // ç»Ÿä¸€å¼•æ“ç®¡ç†
        document.getElementById('checkAllEngines').addEventListener('click', () => {
            this.checkAllEngines();
        });

        document.getElementById('updateAllEngines').addEventListener('click', () => {
            this.updateAllEngines();
        });

        // ç»´æŠ¤æ“ä½œ
        document.getElementById('cleanupFiles').addEventListener('click', () => {
            this.cleanupFiles();
        });

        document.getElementById('refreshSystem').addEventListener('click', () => {
            this.refreshSystem();
        });

        document.getElementById('restartService').addEventListener('click', () => {
            this.restartService();
        });
    }

    async loadSettings() {
        try {
            // åŠ è½½åŸºç¡€è®¾ç½®
            const generalResponse = await apiRequest('/api/settings/general');
            if (generalResponse.ok) {
                const generalData = await generalResponse.json();
                if (generalData.success) {
                    this.settings.general = { ...this.settings.general, ...generalData.settings };
                }
            }

            // åŠ è½½ä¸‹è½½è®¾ç½®
            const downloadResponse = await apiRequest('/api/settings/download');
            if (downloadResponse.ok) {
                const downloadData = await downloadResponse.json();
                if (downloadData.success) {
                    this.settings.download = { ...this.settings.download, ...downloadData.settings };
                }
            }

            // åŠ è½½APIå¯†é’¥è®¾ç½®
            const apiKeyResponse = await apiRequest('/api/settings/api-key');
            if (apiKeyResponse.ok) {
                const apiKeyData = await apiKeyResponse.json();
                if (apiKeyData.success) {
                    this.settings.security.api_key = apiKeyData.api_key;
                    this.settings.security.api_enabled = apiKeyData.has_key;
                }
            }

            // åŠ è½½ä»£ç†è®¾ç½®
            const proxyResponse = await apiRequest('/api/settings/proxy');
            if (proxyResponse.ok) {
                const proxyData = await proxyResponse.json();
                if (proxyData.success) {
                    this.settings.proxy = { ...this.settings.proxy, ...proxyData.proxy };
                }
            }

            this.updateUI();
        } catch (error) {
            console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
        }
    }

    updateUI() {
        // æ›´æ–°åŸºç¡€è®¾ç½®
        document.getElementById('appName').value = this.settings.general.app_name;
        document.getElementById('sessionTimeout').value = this.settings.general.session_timeout;
        document.getElementById('secretKey').value = this.settings.general.secret_key;
        document.getElementById('debugMode').checked = this.settings.general.debug_mode;

        // æ›´æ–°ä¸‹è½½é…ç½®
        document.getElementById('outputDir').value = this.settings.download.output_dir;
        document.getElementById('maxConcurrent').value = this.settings.download.max_concurrent;
        document.getElementById('downloadTimeout').value = this.settings.download.timeout;
        document.getElementById('defaultQuality').value = this.settings.download.default_quality;
        document.getElementById('autoCleanup').checked = this.settings.download.auto_cleanup;
        document.getElementById('fileRetention').value = this.settings.download.file_retention_hours;
        document.getElementById('cleanupInterval').value = this.settings.download.cleanup_interval;
        document.getElementById('maxStorage').value = this.settings.download.max_storage_mb;
        document.getElementById('keepRecentFiles').value = this.settings.download.keep_recent_files;

        // æ›´æ–°å®‰å…¨è®¾ç½®
        document.getElementById('apiEnabled').checked = this.settings.security.api_enabled;
        document.getElementById('apiKey').value = this.settings.security.api_key;

        // æ›´æ–°ä»£ç†è®¾ç½®
        document.getElementById('proxyEnabled').checked = this.settings.proxy.enabled;
        document.getElementById('proxyType').value = this.settings.proxy.proxy_type;
        document.getElementById('proxyHost').value = this.settings.proxy.host;
        document.getElementById('proxyPort').value = this.settings.proxy.port || '';
        document.getElementById('proxyUsername').value = this.settings.proxy.username;
        document.getElementById('proxyPassword').value = this.settings.proxy.password;

        // æ›´æ–°UIçŠ¶æ€
        this.toggleCleanupOptions(this.settings.download.auto_cleanup);
        this.toggleApiKeySection(this.settings.security.api_enabled);
        this.toggleProxySettings(this.settings.proxy.enabled);
        this.updateShortcutInfo();
    }

    toggleSecretKeyVisibility() {
        const input = document.getElementById('secretKey');
        const icon = document.querySelector('#toggleSecretKey i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'bi bi-eye';
        }
    }

    generateSecretKey() {
        const key = this.generateRandomString(32);
        document.getElementById('secretKey').value = key;
        showNotification('æ–°å¯†é’¥å·²ç”Ÿæˆ', 'success');
    }

    generateRandomString(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    toggleCleanupOptions(show) {
        const options = document.getElementById('cleanupOptions');
        options.style.display = show ? 'block' : 'none';
    }

    toggleApiKeySection(show) {
        const section = document.getElementById('apiKeySection');
        section.style.display = show ? 'block' : 'none';
    }

    toggleProxySettings(show) {
        const settings = document.getElementById('proxySettings');
        settings.style.display = show ? 'block' : 'none';
    }

    async saveGeneralSettings() {
        const formData = {
            app_name: document.getElementById('appName').value,
            session_timeout: parseInt(document.getElementById('sessionTimeout').value),
            secret_key: document.getElementById('secretKey').value,
            debug_mode: document.getElementById('debugMode').checked
        };

        try {
            const response = await apiRequest('/api/settings/general', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                showNotification('åŸºç¡€è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
                this.settings.general = formData;
            } else {
                showNotification('ä¿å­˜å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async saveDownloadSettings() {
        const formData = {
            output_dir: document.getElementById('outputDir').value,
            max_concurrent: parseInt(document.getElementById('maxConcurrent').value),
            timeout: parseInt(document.getElementById('downloadTimeout').value),
            default_quality: document.getElementById('defaultQuality').value,
            auto_cleanup: document.getElementById('autoCleanup').checked,
            file_retention_hours: parseInt(document.getElementById('fileRetention').value),
            cleanup_interval: parseInt(document.getElementById('cleanupInterval').value),
            max_storage_mb: parseInt(document.getElementById('maxStorage').value),
            keep_recent_files: parseInt(document.getElementById('keepRecentFiles').value)
        };

        try {
            const response = await apiRequest('/api/settings/download', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                showNotification('ä¸‹è½½é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                this.settings.download = formData;
            } else {
                showNotification('ä¿å­˜å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async changeUsername() {
        const currentPassword = document.getElementById('currentUsernamePassword').value;
        const newUsername = document.getElementById('newUsername').value;

        if (!currentPassword || !newUsername) {
            showNotification('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'warning');
            return;
        }

        if (newUsername.length < 3) {
            showNotification('ç”¨æˆ·åé•¿åº¦ä¸èƒ½å°‘äº3ä¸ªå­—ç¬¦', 'warning');
            return;
        }

        if (!confirm('ä¿®æ”¹ç”¨æˆ·ååéœ€è¦é‡æ–°ç™»å½•ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            return;
        }

        try {
            const response = await apiRequest('/api/auth/change-username', {
                method: 'POST',
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_username: newUsername
                })
            });

            if (response.ok) {
                const data = await response.json();
                showNotification('ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼Œå³å°†è·³è½¬åˆ°ç™»å½•é¡µé¢', 'success');
                document.getElementById('usernameForm').reset();

                // 3ç§’åè·³è½¬åˆ°ç™»å½•é¡µé¢
                setTimeout(() => {
                    window.location.href = '/auth/logout';
                }, 3000);
            } else {
                const data = await response.json();
                showNotification(data.error || 'ç”¨æˆ·åä¿®æ”¹å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async changePassword() {
        const current = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;

        if (newPassword !== confirm) {
            showNotification('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ¹é…', 'danger');
            return;
        }

        try {
            const response = await apiRequest('/api/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    current_password: current,
                    new_password: newPassword
                })
            });

            if (response.ok) {
                showNotification('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
                document.getElementById('passwordForm').reset();
            } else {
                const data = await response.json();
                showNotification(data.error || 'å¯†ç ä¿®æ”¹å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async generateApiKey() {
        try {
            const response = await apiRequest('/api/settings/api-key/generate', {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.settings.security.api_key = data.api_key;
                    this.settings.security.api_enabled = true;
                    document.getElementById('apiKey').value = data.api_key;
                    document.getElementById('apiEnabled').checked = true;
                    this.toggleApiKeySection(true);
                    this.updateShortcutInfo();
                    showNotification(data.message || 'æ–°APIå¯†é’¥å·²ç”Ÿæˆ', 'success');
                }
            } else {
                const data = await response.json();
                showNotification(data.error || 'APIå¯†é’¥ç”Ÿæˆå¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async saveApiSettings() {
        const formData = {
            api_key: document.getElementById('apiEnabled').checked ? document.getElementById('apiKey').value : ''
        };

        try {
            const response = await apiRequest('/api/settings/api-key', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const data = await response.json();
                showNotification(data.message || 'APIè®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
                this.settings.security.api_enabled = Boolean(formData.api_key);
                this.settings.security.api_key = formData.api_key;
                this.updateShortcutInfo();
            } else {
                const data = await response.json();
                showNotification(data.error || 'ä¿å­˜å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    updateShortcutInfo() {
        const serverUrl = window.location.origin;
        const downloadEndpoint = serverUrl + '/api/shortcuts/download';

        document.getElementById('serverUrl').value = serverUrl;
        document.getElementById('downloadEndpoint').value = downloadEndpoint;

        // æ›´æ–°APIå¯†é’¥æ˜¾ç¤º
        if (this.settings.security.api_enabled && this.settings.security.api_key) {
            document.getElementById('apiKeyDisplay').value = this.settings.security.api_key;
            document.getElementById('apiKeySection2').style.display = 'block';
            document.getElementById('apiKeyWarning2').style.display = 'none';
        } else {
            document.getElementById('apiKeySection2').style.display = 'none';
            document.getElementById('apiKeyWarning2').style.display = 'block';
        }
    }

    async checkSystemInfo() {
        try {
            const response = await apiRequest('/api/system/info');
            if (response.ok) {
                const data = await response.json();

                if (data.success) {
                    document.getElementById('usedSpace').textContent = this.formatSize(data.storage?.used || 0);
                    document.getElementById('freeSpace').textContent = this.formatSize(data.storage?.free || 0);
                    document.getElementById('uptime').textContent = this.formatUptime(data.uptime || 0);
                    document.getElementById('activeDownloads').textContent = data.active_downloads || 0;
                } else {
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    document.getElementById('usedSpace').textContent = 'è·å–å¤±è´¥';
                    document.getElementById('freeSpace').textContent = 'è·å–å¤±è´¥';
                    document.getElementById('uptime').textContent = 'è·å–å¤±è´¥';
                    document.getElementById('activeDownloads').textContent = '0';
                }
            }
        } catch (error) {
            console.error('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', error);
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            document.getElementById('usedSpace').textContent = 'ç½‘ç»œé”™è¯¯';
            document.getElementById('freeSpace').textContent = 'ç½‘ç»œé”™è¯¯';
            document.getElementById('uptime').textContent = 'ç½‘ç»œé”™è¯¯';
            document.getElementById('activeDownloads').textContent = '0';
        }
    }

    formatSize(bytes) {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    formatUptime(seconds) {
        if (!seconds) return '0ç§’';
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);

        if (days > 0) return `${days}å¤© ${hours}å°æ—¶`;
        if (hours > 0) return `${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
        return `${minutes}åˆ†é’Ÿ`;
    }

    // ç®€åŒ–çš„å¼•æ“ç®¡ç†æ–¹æ³•
    async checkYtdlpInfo() {
        try {
            const response = await apiRequest('/api/system/ytdlp/info');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.info) {
                    document.getElementById('ytdlpVersion').textContent = data.info.version || 'æœªçŸ¥ç‰ˆæœ¬';
                } else {
                    document.getElementById('ytdlpVersion').textContent = 'æœªå®‰è£…';
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥yt-dlpä¿¡æ¯å¤±è´¥:', error);
            document.getElementById('ytdlpVersion').textContent = 'æ£€æŸ¥å¤±è´¥';
        }
    }

    async updateYtdlp() {
        if (!confirm('ç¡®å®šè¦æ›´æ–°yt-dlpå—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) return;

        try {
            const response = await apiRequest('/api/system/update-ytdlp', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('yt-dlpæ›´æ–°å·²å¼€å§‹', 'info');
                setTimeout(() => this.checkYtdlpInfo(), 5000);
            } else {
                showNotification('æ›´æ–°å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async installYtdlp() {
        if (!confirm('ç¡®å®šè¦é‡æ–°å®‰è£…yt-dlpå—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰ç‰ˆæœ¬ã€‚')) return;

        try {
            const response = await apiRequest('/api/system/install-ytdlp', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('yt-dlpé‡æ–°å®‰è£…å·²å¼€å§‹', 'info');
                setTimeout(() => this.checkYtdlpInfo(), 10000);
            } else {
                showNotification('å®‰è£…å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async checkPytubefixInfo() {
        try {
            const response = await apiRequest('/api/system/pytubefix/info');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.pytubefix_info) {
                    document.getElementById('pytubefixVersion').textContent = data.pytubefix_info.version || 'æœªçŸ¥ç‰ˆæœ¬';
                } else {
                    document.getElementById('pytubefixVersion').textContent = 'æœªå®‰è£…';
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥PyTubeFixä¿¡æ¯å¤±è´¥:', error);
            document.getElementById('pytubefixVersion').textContent = 'æ£€æŸ¥å¤±è´¥';
        }
    }

    async updatePytubefix() {
        if (!confirm('ç¡®å®šè¦æ›´æ–°PyTubeFixå—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) return;

        try {
            const response = await apiRequest('/api/system/update-pytubefix', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('PyTubeFixæ›´æ–°å·²å¼€å§‹', 'info');
                setTimeout(() => this.checkPytubefixInfo(), 5000);
            } else {
                showNotification('æ›´æ–°å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async installPytubefix() {
        if (!confirm('ç¡®å®šè¦é‡æ–°å®‰è£…PyTubeFixå—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰ç‰ˆæœ¬ã€‚')) return;

        try {
            const response = await apiRequest('/api/system/install-pytubefix', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('PyTubeFixé‡æ–°å®‰è£…å·²å¼€å§‹', 'info');
                setTimeout(() => this.checkPytubefixInfo(), 10000);
            } else {
                showNotification('å®‰è£…å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async checkAllEngines() {
        try {
            const response = await apiRequest('/api/system/engines/status');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.engines) {
                    // æ›´æ–°yt-dlpç‰ˆæœ¬æ˜¾ç¤º
                    if (data.engines.ytdlp) {
                        document.getElementById('ytdlpVersion').textContent = data.engines.ytdlp.version || 'æœªçŸ¥ç‰ˆæœ¬';
                    }
                    // æ›´æ–°PyTubeFixç‰ˆæœ¬æ˜¾ç¤º
                    if (data.engines.pytubefix) {
                        document.getElementById('pytubefixVersion').textContent = data.engines.pytubefix.version || 'æœªçŸ¥ç‰ˆæœ¬';
                    }

                    showNotification('å¼•æ“çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
                } else {
                    showNotification('è·å–å¼•æ“çŠ¶æ€å¤±è´¥', 'danger');
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥å¼•æ“çŠ¶æ€å¤±è´¥:', error);
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async updateAllEngines() {
        if (!confirm('ç¡®å®šè¦æ›´æ–°æ‰€æœ‰ä¸‹è½½å¼•æ“å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) return;

        try {
            const response = await apiRequest('/api/system/engines/update-all', {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showNotification(`å¼•æ“æ›´æ–°å®Œæˆ: ${data.summary.successful}/${data.summary.total} æˆåŠŸ`, 'success');
                    // 5ç§’ååˆ·æ–°çŠ¶æ€
                    setTimeout(() => this.checkAllEngines(), 5000);
                } else {
                    showNotification('å¼•æ“æ›´æ–°å¤±è´¥', 'danger');
                }
            } else {
                showNotification('æ›´æ–°å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async saveProxySettings() {
        const formData = {
            enabled: document.getElementById('proxyEnabled').checked,
            proxy_type: document.getElementById('proxyType').value,
            host: document.getElementById('proxyHost').value.trim(),
            port: parseInt(document.getElementById('proxyPort').value) || null,
            username: document.getElementById('proxyUsername').value.trim(),
            password: document.getElementById('proxyPassword').value
        };

        try {
            const response = await apiRequest('/api/settings/proxy', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const data = await response.json();
                showNotification(data.message || 'ä»£ç†è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
                this.settings.proxy = formData;
            } else {
                const data = await response.json();
                showNotification(data.error || 'ä¿å­˜å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async cleanupFiles() {
        if (!confirm('ç¡®å®šè¦æ¸…ç†è¿‡æœŸæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

        try {
            const response = await apiRequest('/api/system/cleanup', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('æ–‡ä»¶æ¸…ç†å®Œæˆ', 'success');
                this.checkSystemInfo();
            } else {
                showNotification('æ¸…ç†å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async refreshSystem() {
        try {
            await this.checkSystemInfo();
            await this.checkYtdlpInfo();
            await this.checkPytubefixInfo();
            showNotification('ç³»ç»Ÿä¿¡æ¯å·²åˆ·æ–°', 'success');
        } catch (error) {
            showNotification('åˆ·æ–°å¤±è´¥', 'danger');
        }
    }

    async restartService() {
        if (!confirm('ç¡®å®šè¦é‡å¯æœåŠ¡å—ï¼Ÿè¿™å°†ä¸­æ–­æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„ä¸‹è½½ã€‚')) return;

        try {
            const response = await apiRequest('/api/system/restart', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('æœåŠ¡é‡å¯ä¸­...', 'info');
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                showNotification('é‡å¯å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }
}

// å…¨å±€å‡½æ•°
async function testProxy() {
    const formData = {
        proxy_type: document.getElementById('proxyType').value,
        host: document.getElementById('proxyHost').value.trim(),
        port: parseInt(document.getElementById('proxyPort').value) || null,
        username: document.getElementById('proxyUsername').value.trim(),
        password: document.getElementById('proxyPassword').value
    };

    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!formData.host || !formData.port) {
        showNotification('è¯·å¡«å†™ä»£ç†åœ°å€å’Œç«¯å£', 'warning');
        return;
    }

    const resultSpan = document.getElementById('proxyTestResult');
    resultSpan.innerHTML = '<span class="text-info">æµ‹è¯•ä¸­...</span>';

    try {
        const response = await apiRequest('/api/settings/proxy/test', {
            method: 'POST',
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                resultSpan.innerHTML = `<span class="text-success">âœ… è¿æ¥æˆåŠŸ (IP: ${data.ip}, å“åº”æ—¶é—´: ${data.response_time})</span>`;
            } else {
                resultSpan.innerHTML = `<span class="text-danger">âŒ ${data.error}</span>`;
            }
        } else {
            const data = await response.json();
            resultSpan.innerHTML = `<span class="text-danger">âŒ ${data.error}</span>`;
        }
    } catch (error) {
        resultSpan.innerHTML = '<span class="text-danger">âŒ ç½‘ç»œé”™è¯¯</span>';
    }
}

async function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.value;

    try {
        await navigator.clipboard.writeText(text);
        showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    } catch (error) {
        // é™çº§å¤„ç†
        element.select();
        document.execCommand('copy');
        showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }
}

// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', function() {
    new SettingsApp();
});
</script>
{% endblock %}
