{% extends "base_modern.html" %}

{% block title %}Cookies ç®¡ç†ä¸­å¿ƒ - YT-DLP Web{% endblock %}

{% block content %}
<div class="container-fluid" id="cookiesApp">
    
    <!-- ğŸ¨ ç°ä»£åŒ–é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-3">
        <div class="col-lg-8 mx-auto">
            <div class="text-center animate-fade-in-up">
                <h1 class="display-5 fw-bold text-gradient mb-2">
                    <i class="bi bi-cookie me-3"></i>Cookies ç®¡ç†ä¸­å¿ƒ
                </h1>
                <p class="lead text-muted mb-3">
                    ç®¡ç†ç½‘ç«™Cookiesä»¥è·å¾—æœ€ä½³ä¸‹è½½ä½“éªŒå’Œè®¿é—®æƒé™
                </p>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                    <span class="badge rounded-pill px-3 py-2" style="background: var(--gradient-primary); color: white;">
                        <i class="bi bi-upload me-1"></i>æ–‡ä»¶ä¸Šä¼ 
                    </span>
                    <span class="badge rounded-pill px-3 py-2" style="background: var(--gradient-success); color: white;">
                        <i class="bi bi-check-circle me-1"></i>æ ¼å¼éªŒè¯
                    </span>
                    <span class="badge rounded-pill px-3 py-2" style="background: var(--gradient-warning); color: white;">
                        <i class="bi bi-shield me-1"></i>å®‰å…¨å­˜å‚¨
                    </span>
                    <span class="badge rounded-pill px-3 py-2" style="background: var(--gradient-danger); color: white;">
                        <i class="bi bi-tools me-1"></i>è‡ªåŠ¨ä¿®å¤
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ğŸ“¤ ç°ä»£åŒ–ä¸Šä¼ Cookies -->
    <div class="row mb-3">
        <div class="col-lg-8 mx-auto">
            <div class="modern-card p-4">
                <h5 class="mb-3 fw-bold">
                    <i class="bi bi-upload me-2 text-primary"></i>ä¸Šä¼ Cookiesæ–‡ä»¶
                </h5>
                    
                    <form id="cookiesForm">
                        <div class="row g-3 mb-2">
                        <!-- ğŸŒ ç½‘ç«™é€‰æ‹© -->
                        <div class="col-md-6">
                            <label for="website" class="form-label fw-bold">
                                <i class="bi bi-globe me-1 text-primary"></i>ç›®æ ‡ç½‘ç«™
                            </label>
                            <select class="form-select modern-input" id="website">
                                <option value="">ğŸŒ é€‰æ‹©ç½‘ç«™</option>
                                <option value="youtube">ğŸ“º YouTube</option>
                                <option value="bilibili">ğŸ¬ Bilibili</option>
                                <option value="twitter">ğŸ¦ Twitter/X</option>
                                <option value="instagram">ğŸ“· Instagram</option>
                                <option value="tiktok">ğŸµ TikTok</option>
                                <option value="custom">âš™ï¸ è‡ªå®šä¹‰</option>
                            </select>
                        </div>

                        <!-- ğŸ”§ è‡ªå®šä¹‰ç½‘ç«™å -->
                        <div class="col-md-6" id="customWebsiteDiv" style="display: none;">
                            <label for="customWebsite" class="form-label fw-bold">
                                <i class="bi bi-pencil me-1 text-success"></i>è‡ªå®šä¹‰ç½‘ç«™å
                            </label>
                            <input type="text" class="form-control modern-input" id="customWebsite" placeholder="ä¾‹å¦‚: example.com">
                        </div>
                        </div>
                        
                        <!-- ä¸Šä¼ æ–¹å¼é€‰æ‹© -->
                        <div class="mb-2">
                            <label class="form-label">ä¸Šä¼ æ–¹å¼</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="uploadMethod" id="fileMethod" value="file" checked>
                                    <label class="form-check-label" for="fileMethod">æ–‡ä»¶ä¸Šä¼ </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="uploadMethod" id="textMethod" value="text">
                                    <label class="form-check-label" for="textMethod">æ–‡æœ¬ç²˜è´´</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ–‡ä»¶ä¸Šä¼  -->
                        <div id="fileUploadDiv" class="mb-2">
                            <label for="cookiesFile" class="form-label">Cookiesæ–‡ä»¶</label>
                            <div class="border border-2 border-dashed rounded p-4 text-center" style="min-height: 200px;">
                                <input type="file" class="form-control d-none" id="cookiesFile" accept=".txt,.json">
                                <div id="fileDropZone" class="d-flex flex-column justify-content-center h-100">
                                    <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                                    <p class="text-muted mb-2">
                                        æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ– 
                                        <button type="button" class="btn btn-link p-0" id="selectFileBtn">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</button>
                                    </p>
                                    <small class="text-muted">æ”¯æŒ .txt å’Œ .json æ ¼å¼</small>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">â€¢ æ”¯æŒNetscapeæ ¼å¼ (æµè§ˆå™¨å¯¼å‡º)</small>
                                        <small class="text-muted d-block">â€¢ æ”¯æŒJSONæ ¼å¼ (å¼€å‘è€…å·¥å…·)</small>
                                        <small class="text-muted d-block">â€¢ æ”¯æŒé”®å€¼å¯¹æ ¼å¼ (name=value)</small>
                                    </div>
                                </div>
                                <div id="fileSelected" class="d-none">
                                    <i class="bi bi-file-earmark-text display-4 text-success mb-2"></i>
                                    <p class="mb-0" id="fileName"></p>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="clearFileBtn">
                                        <i class="bi bi-x"></i> æ¸…é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ–‡æœ¬ç²˜è´´ -->
                        <div id="textUploadDiv" class="mb-2" style="display: none;">
                            <label for="cookiesContent" class="form-label">Cookieså†…å®¹</label>
                            <textarea class="form-control" id="cookiesContent" rows="10" 
                                      placeholder="ç²˜è´´Cookieså†…å®¹...&#10;&#10;æ”¯æŒä»¥ä¸‹æ ¼å¼:&#10;1. Netscapeæ ¼å¼ (æµè§ˆå™¨å¯¼å‡º)&#10;2. JSONæ ¼å¼ (å¼€å‘è€…å·¥å…·)&#10;3. é”®å€¼å¯¹æ ¼å¼ (name=value)"></textarea>
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted" id="charCount">0 å­—ç¬¦</small>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-secondary" id="clearTextBtn">æ¸…ç©º</button>
                                    <button type="button" class="btn btn-outline-primary" id="formatBtn">æ ¼å¼åŒ–</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ ¼å¼è¯´æ˜ -->
                        <div class="modern-card p-4" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                            <div class="d-flex justify-content-between align-items-center text-white">
                                <h6 class="mb-0 fw-bold">æ”¯æŒçš„æ ¼å¼</h6>
                                <button type="button" class="btn btn-sm btn-outline-light" id="toggleExamples">
                                    æŸ¥çœ‹ç¤ºä¾‹
                                </button>
                            </div>
                            <ul class="mb-0 mt-2 text-white">
                                <li><strong>Netscapeæ ¼å¼</strong>: æµè§ˆå™¨å¯¼å‡ºçš„æ ‡å‡†æ ¼å¼</li>
                                <li><strong>JSONæ ¼å¼</strong>: å¼€å‘è€…å·¥å…·å¯¼å‡ºçš„æ ¼å¼</li>
                                <li><strong>é”®å€¼å¯¹æ ¼å¼</strong>: ç®€å•çš„ name=value æ ¼å¼</li>
                                <li><strong>è‡ªåŠ¨æ£€æµ‹</strong>: ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ ¼å¼å¹¶è½¬æ¢</li>
                            </ul>

                            <!-- æ ¼å¼ç¤ºä¾‹ -->
                            <div id="formatExamples" class="mt-3" style="display: none;">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <h6 class="text-white">Netscapeæ ¼å¼:</h6>
                                        <pre class="small bg-white bg-opacity-25 text-white p-2 rounded"># Netscape HTTP Cookie File
.youtube.com	TRUE	/	FALSE	1234567890	session_token	abc123</pre>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-white">JSONæ ¼å¼:</h6>
                                        <pre class="small bg-white bg-opacity-25 text-white p-2 rounded">[{
  "name": "session_token",
  "value": "abc123",
  "domain": ".youtube.com"
}]</pre>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-white">é”®å€¼å¯¹æ ¼å¼:</h6>
                                        <pre class="small bg-white bg-opacity-25 text-white p-2 rounded">session_token=abc123
secure_token=def456
user_id=12345</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    <!-- ğŸ›ï¸ æ“ä½œæŒ‰é’® -->
                    <div class="d-flex gap-3 flex-wrap">
                        <button type="button" class="btn btn-outline-success modern-btn" id="validateBtn">
                            <i class="bi bi-check-circle me-2"></i>éªŒè¯æ ¼å¼
                        </button>
                        <button type="submit" class="btn btn-primary modern-btn py-3 px-5"
                                style="background: var(--gradient-primary); border: none; font-size: 1.1rem;">
                            <i class="bi bi-upload me-2"></i>ä¸Šä¼ Cookies
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ğŸ”‘ YouTubeè®¤è¯é…ç½® -->
    <div class="row mb-3" id="auth-config">
        <div class="col-lg-8 mx-auto">
            <div class="modern-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-key me-2 text-warning"></i>YouTube è®¤è¯é…ç½®
                        <span class="badge rounded-pill ms-2" style="background: var(--gradient-warning); color: white;" id="authStatusBadge">æœªé…ç½®</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info modern-btn" id="authGuideBtn">
                            <i class="bi bi-book me-1"></i>è·å–æŒ‡å—
                        </button>
                        <button type="button" class="btn btn-outline-success modern-btn" id="testAuthBtn">
                            <i class="bi bi-play-circle me-1"></i>æµ‹è¯•é…ç½®
                        </button>
                    </div>
                </div>

                <!-- YouTubeè®¤è¯é…ç½®è¡¨å• -->
                <form id="authConfigForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-key me-1 text-primary"></i>PO Token
                            </label>
                            <textarea class="form-control modern-input" id="poToken" rows="3"
                                      placeholder="è¯·è¾“å…¥ä»YouTubeè·å–çš„PO Token..."></textarea>
                            <div class="form-text">ç”¨äºç»•è¿‡YouTubeè®¿é—®é™åˆ¶ï¼Œæ”¯æŒé«˜åˆ†è¾¨ç‡è§†é¢‘ä¸‹è½½</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-person-badge me-1 text-success"></i>Visitor Data
                            </label>
                            <input type="text" class="form-control modern-input" id="visitorData"
                                   placeholder="è¯·è¾“å…¥Visitor Data...">
                            <div class="form-text">ç”¨äºèº«ä»½éªŒè¯ï¼Œæé«˜ä¸‹è½½æˆåŠŸç‡</div>

                            <label class="form-label fw-bold mt-3">
                                <i class="bi bi-shield-check me-1 text-info"></i>OAuth2 Token (å¯é€‰)
                            </label>
                            <input type="text" class="form-control modern-input" id="oauth2Token"
                                   placeholder="è¯·è¾“å…¥OAuth2 Token (å¯é€‰)...">
                            <div class="form-text">å¯è¿›ä¸€æ­¥æé«˜ä¸‹è½½æˆåŠŸç‡ï¼Œä½†ä¸æ˜¯å¿…éœ€çš„</div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-3 flex-wrap">
                        <button type="submit" class="btn btn-primary modern-btn">
                            <i class="bi bi-check-circle me-1"></i>ä¿å­˜é…ç½®
                        </button>
                        <button type="button" class="btn btn-outline-success modern-btn" id="autoGenerateBtn">
                            <i class="bi bi-magic me-1"></i>è‡ªåŠ¨è·å–
                        </button>
                        <button type="button" class="btn btn-outline-info modern-btn" id="manualGuideBtn">
                            <i class="bi bi-book me-1"></i>æ‰‹åŠ¨æŒ‡å—
                        </button>
                        <button type="button" class="btn btn-outline-danger modern-btn" id="clearAuthBtn">
                            <i class="bi bi-trash me-1"></i>æ¸…é™¤é…ç½®
                        </button>
                    </div>
                </form>

                <!-- è®¤è¯çŠ¶æ€æ˜¾ç¤º -->
                <div id="authStatus" class="mt-4">
                    <h6 class="fw-bold mb-3">é…ç½®çŠ¶æ€</h6>
                    <div class="row g-3" id="authStatusCards">
                        <!-- åŠ¨æ€ç”ŸæˆçŠ¶æ€å¡ç‰‡ -->
                    </div>

                    <!-- PO Tokenè¯¦ç»†ä¿¡æ¯ -->
                    <div id="poTokenDetails" class="mt-3" style="display: none;">
                        <div class="card" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-info-circle me-2"></i>PO Token è¯¦ç»†ä¿¡æ¯
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <small class="text-muted">ç”Ÿæˆæ—¶é—´:</small>
                                        <div id="poTokenGeneratedTime">-</div>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">æœ€åéªŒè¯:</small>
                                        <div id="poTokenLastValidated">-</div>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">çŠ¶æ€:</small>
                                        <div id="poTokenStatus">
                                            <span class="badge bg-secondary">æœªçŸ¥</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">æ¥æº:</small>
                                        <div id="poTokenSource">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ’¾ ç°ä»£åŒ–å·²ä¿å­˜çš„Cookies -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="modern-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-database me-2 text-primary"></i>å·²ä¿å­˜çš„Cookies
                        <span class="badge rounded-pill ms-2" style="background: var(--gradient-secondary); color: white;" id="cookiesCount">0</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary modern-btn" id="refreshBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
                        </button>
                        <button type="button" class="btn btn-outline-warning modern-btn" id="fixBtn">
                            <i class="bi bi-tools me-1"></i>ä¿®å¤æ ¼å¼
                        </button>
                    </div>
                </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="emptyState" class="text-center py-5">
                        <i class="bi bi-cookie display-4 text-muted"></i>
                        <h6 class="mt-3 text-muted">æš‚æ— ä¿å­˜çš„Cookies</h6>
                        <p class="text-muted">ä¸Šä¼ ä¸€äº›Cookiesæ–‡ä»¶æ¥å¼€å§‹ä½¿ç”¨</p>
                    </div>

                    <!-- Cookiesåˆ—è¡¨ -->
                    <div id="cookiesList" class="d-none">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
class CookiesApp {
    constructor() {
        this.uploadForm = {
            website: '',
            customWebsite: '',
            method: 'file',
            file: null,
            content: ''
        };
        this.cookies = [];
        this.showExamples = false;
        this.authConfig = {
            po_token: '',
            visitor_data: '',
            oauth2_token: ''
        };

        this.init();
    }

    init() {
        this.bindEvents();
        this.loadCookies();
        this.loadAuthConfig();
    }

    bindEvents() {
        // è¡¨å•æäº¤
        document.getElementById('cookiesForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.uploadCookies();
        });

        // ç½‘ç«™é€‰æ‹©
        document.getElementById('website').addEventListener('change', (e) => {
            this.uploadForm.website = e.target.value;
            this.toggleCustomWebsite(e.target.value === 'custom');
        });

        // è‡ªå®šä¹‰ç½‘ç«™å
        document.getElementById('customWebsite').addEventListener('input', (e) => {
            this.uploadForm.customWebsite = e.target.value;
        });

        // ä¸Šä¼ æ–¹å¼åˆ‡æ¢
        document.querySelectorAll('input[name="uploadMethod"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.uploadForm.method = e.target.value;
                this.toggleUploadMethod(e.target.value);
            });
        });

        // æ–‡ä»¶é€‰æ‹©
        document.getElementById('selectFileBtn').addEventListener('click', () => {
            document.getElementById('cookiesFile').click();
        });

        document.getElementById('cookiesFile').addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files[0]);
        });

        // æ¸…é™¤æ–‡ä»¶
        document.getElementById('clearFileBtn').addEventListener('click', () => {
            this.clearFile();
        });

        // æ–‡æœ¬å†…å®¹
        document.getElementById('cookiesContent').addEventListener('input', (e) => {
            this.uploadForm.content = e.target.value;
            this.updateCharCount();
        });

        // æ–‡æœ¬æ“ä½œæŒ‰é’®
        document.getElementById('clearTextBtn').addEventListener('click', () => {
            document.getElementById('cookiesContent').value = '';
            this.uploadForm.content = '';
            this.updateCharCount();
        });

        document.getElementById('formatBtn').addEventListener('click', () => {
            this.formatContent();
        });

        // ç¤ºä¾‹åˆ‡æ¢
        document.getElementById('toggleExamples').addEventListener('click', () => {
            this.toggleExamples();
        });

        // éªŒè¯æŒ‰é’®
        document.getElementById('validateBtn').addEventListener('click', () => {
            this.validateCookies();
        });

        // åˆ·æ–°æŒ‰é’®
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.loadCookies();
        });

        // ä¿®å¤æŒ‰é’®
        document.getElementById('fixBtn').addEventListener('click', () => {
            this.fixCookies();
        });

        // YouTubeè®¤è¯é…ç½®äº‹ä»¶
        document.getElementById('authConfigForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveAuthConfig();
        });

        document.getElementById('authGuideBtn').addEventListener('click', () => {
            window.open('/cookies/auth-guide', '_blank');
        });

        document.getElementById('testAuthBtn').addEventListener('click', () => {
            this.testAuthConfig();
        });

        document.getElementById('clearAuthBtn').addEventListener('click', () => {
            this.clearAuthConfig();
        });

        document.getElementById('autoGenerateBtn').addEventListener('click', () => {
            this.autoGeneratePOToken();
        });

        document.getElementById('manualGuideBtn').addEventListener('click', () => {
            this.showManualGuide();
        });

        // è®¤è¯é…ç½®è¾“å…¥äº‹ä»¶
        ['poToken', 'visitorData', 'oauth2Token'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                this.authConfig[id.replace(/([A-Z])/g, '_$1').toLowerCase()] = e.target.value;
            });
        });

        // æ‹–æ‹½æ”¯æŒ
        const dropZone = document.getElementById('fileDropZone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary');
            const file = e.dataTransfer.files[0];
            if (file) {
                this.handleFileSelect(file);
            }
        });
    }

    toggleCustomWebsite(show) {
        const div = document.getElementById('customWebsiteDiv');
        div.style.display = show ? 'block' : 'none';
    }

    toggleUploadMethod(method) {
        const fileDiv = document.getElementById('fileUploadDiv');
        const textDiv = document.getElementById('textUploadDiv');

        if (method === 'file') {
            fileDiv.style.display = 'block';
            textDiv.style.display = 'none';
        } else {
            fileDiv.style.display = 'none';
            textDiv.style.display = 'block';
        }
    }

    handleFileSelect(file) {
        if (file) {
            this.uploadForm.file = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileDropZone').classList.add('d-none');
            document.getElementById('fileSelected').classList.remove('d-none');
        }
    }

    clearFile() {
        this.uploadForm.file = null;
        document.getElementById('cookiesFile').value = '';
        document.getElementById('fileDropZone').classList.remove('d-none');
        document.getElementById('fileSelected').classList.add('d-none');
    }

    updateCharCount() {
        const count = this.uploadForm.content.length;
        document.getElementById('charCount').textContent = `${count} å­—ç¬¦`;
    }

    toggleExamples() {
        const examples = document.getElementById('formatExamples');
        const btn = document.getElementById('toggleExamples');

        this.showExamples = !this.showExamples;
        examples.style.display = this.showExamples ? 'block' : 'none';
        btn.textContent = this.showExamples ? 'éšè—ç¤ºä¾‹' : 'æŸ¥çœ‹ç¤ºä¾‹';
    }

    formatContent() {
        const content = this.uploadForm.content.trim();
        if (!content) return;

        try {
            // å°è¯•æ ¼å¼åŒ–JSON
            const parsed = JSON.parse(content);
            document.getElementById('cookiesContent').value = JSON.stringify(parsed, null, 2);
            this.uploadForm.content = document.getElementById('cookiesContent').value;
            this.updateCharCount();
            showNotification('å†…å®¹å·²æ ¼å¼åŒ–', 'success');
        } catch (error) {
            showNotification('æ— æ³•æ ¼å¼åŒ–å†…å®¹ï¼Œè¯·æ£€æŸ¥æ ¼å¼', 'warning');
        }
    }

    async validateCookies() {
        if (!this.hasContent()) {
            showNotification('è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©Cookieså†…å®¹', 'warning');
            return;
        }

        try {
            let content = '';

            if (this.uploadForm.method === 'file' && this.uploadForm.file) {
                content = await this.readFileContent(this.uploadForm.file);
            } else {
                content = this.uploadForm.content;
            }

            const response = await apiRequest('/cookies/api/validate', {
                method: 'POST',
                body: JSON.stringify({ cookies: content })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showNotification(
                        `éªŒè¯æˆåŠŸï¼æ ¼å¼: ${data.format}ï¼ŒåŒ…å« ${data.count} ä¸ªCookie`,
                        'success'
                    );
                } else {
                    showNotification(data.error || 'éªŒè¯å¤±è´¥', 'danger');
                }
            } else {
                const data = await response.json();
                showNotification(data.error || 'éªŒè¯å¤±è´¥', 'danger');
            }
        } catch (error) {
            console.error('éªŒè¯å¤±è´¥:', error);
            showNotification('éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', 'danger');
        }
    }

    async readFileContent(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
        });
    }

    hasContent() {
        return this.uploadForm.method === 'file' ?
               this.uploadForm.file :
               this.uploadForm.content.trim();
    }

    canUpload() {
        const hasWebsite = this.uploadForm.website &&
                          (this.uploadForm.website !== 'custom' || this.uploadForm.customWebsite);
        const hasContent = this.hasContent();
        return hasWebsite && hasContent;
    }

    async uploadCookies() {
        if (!this.canUpload()) {
            showNotification('è¯·å®Œæ•´å¡«å†™è¡¨å•', 'warning');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('website', this.uploadForm.website === 'custom' ?
                           this.uploadForm.customWebsite : this.uploadForm.website);

            if (this.uploadForm.method === 'file') {
                formData.append('file', this.uploadForm.file);
            } else {
                formData.append('content', this.uploadForm.content);
            }

            const response = await apiRequest('/cookies/api/upload', {
                method: 'POST',
                body: formData,
                headers: {} // è®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®Content-Type
            });

            if (response.ok) {
                showNotification('Cookiesä¸Šä¼ æˆåŠŸ', 'success');
                this.resetForm();
                await this.loadCookies();
            } else {
                const data = await response.json();
                showNotification(data.error || 'Cookiesä¸Šä¼ å¤±è´¥', 'danger');
            }
        } catch (error) {
            console.error('ä¸Šä¼ å¤±è´¥:', error);
            showNotification('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', 'danger');
        }
    }

    resetForm() {
        this.uploadForm = {
            website: '',
            customWebsite: '',
            method: 'file',
            file: null,
            content: ''
        };

        document.getElementById('cookiesForm').reset();
        this.clearFile();
        this.toggleCustomWebsite(false);
        this.updateCharCount();
    }

    async loadCookies() {
        try {
            const response = await apiRequest('/cookies/api/list');
            if (response.ok) {
                const data = await response.json();
                this.cookies = data.cookies || [];
                this.renderCookies();
            }
        } catch (error) {
            console.error('åŠ è½½Cookieså¤±è´¥:', error);
        }
    }

    renderCookies() {
        const emptyState = document.getElementById('emptyState');
        const cookiesList = document.getElementById('cookiesList');
        const countBadge = document.getElementById('cookiesCount');

        countBadge.textContent = this.cookies.length;

        if (this.cookies.length === 0) {
            emptyState.classList.remove('d-none');
            cookiesList.classList.add('d-none');
            return;
        }

        emptyState.classList.add('d-none');
        cookiesList.classList.remove('d-none');

        cookiesList.innerHTML = this.cookies.map(cookie => `
            <div class="border rounded p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                             style="width: 40px; height: 40px;">
                            ${cookie.website.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h6 class="mb-1">${this.getWebsiteName(cookie.website)}</h6>
                            <small class="text-muted">
                                ${cookie.count} ä¸ªCookie â€¢ ä¸Šä¼ äº ${this.formatDate(cookie.created_at)}
                            </small>
                        </div>
                    </div>

                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="app.testCookies('${cookie.website}')" title="æµ‹è¯•">
                            <i class="bi bi-check-circle"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="app.downloadCookies('${cookie.website}')" title="å¯¼å‡º">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="app.deleteCookies('${cookie.website}')" title="åˆ é™¤">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    getWebsiteName(website) {
        const names = {
            'youtube': 'YouTube',
            'bilibili': 'Bilibili',
            'twitter': 'Twitter/X',
            'instagram': 'Instagram',
            'tiktok': 'TikTok'
        };
        return names[website] || website;
    }

    // ä½¿ç”¨æœåŠ¡å±‚çš„æ ¼å¼åŒ–å‡½æ•°
    formatDate(dateString) {
        return window.appManager?.services?.download?.formatDate(dateString) || '';
    }

    async testCookies(website) {
        try {
            const response = await apiRequest(`/cookies/api/test/${website}`, {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                showNotification(data.success ? 'Cookiesæµ‹è¯•æˆåŠŸ' : 'Cookiesæµ‹è¯•å¤±è´¥',
                               data.success ? 'success' : 'warning');
            } else {
                showNotification('æµ‹è¯•å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    downloadCookies(website) {
        window.open(`/cookies/api/download/${website}`, '_blank');
    }

    async deleteCookies(website) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${this.getWebsiteName(website)} çš„Cookieså—ï¼Ÿ`)) return;

        try {
            const response = await apiRequest(`/cookies/api/delete/${website}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Cookiesåˆ é™¤æˆåŠŸ', 'success');
                await this.loadCookies();
            } else {
                showNotification('åˆ é™¤å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    async fixCookies() {
        if (!confirm('ç¡®å®šè¦ä¿®å¤æ‰€æœ‰Cookiesæ ¼å¼å—ï¼Ÿ')) return;

        try {
            const response = await apiRequest('/cookies/api/fix-cookies', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('Cookiesæ ¼å¼ä¿®å¤å®Œæˆ', 'success');
                await this.loadCookies();
            } else {
                showNotification('ä¿®å¤å¤±è´¥', 'danger');
            }
        } catch (error) {
            showNotification('ç½‘ç»œé”™è¯¯', 'danger');
        }
    }

    // YouTubeè®¤è¯é…ç½®æ–¹æ³•
    async loadAuthConfig() {
        try {
            const response = await apiRequest('/cookies/api/youtube-auth/get');
            const data = await response.json();

            if (data.success) {
                // æ³¨æ„ï¼šAPIè¿”å›çš„æ˜¯é¢„è§ˆæ•°æ®ï¼Œéœ€è¦è·å–å®Œæ•´æ•°æ®
                this.authConfig = {
                    po_token: data.po_token || '',
                    visitor_data: data.visitor_data || '',
                    oauth2_token: data.oauth2_token || ''
                };

                // æ›´æ–°è¡¨å• - å¦‚æœæœ‰é¢„è§ˆæ•°æ®ï¼Œæ˜¾ç¤ºé¢„è§ˆï¼Œå¦åˆ™ä¸ºç©º
                document.getElementById('poToken').value = this.authConfig.po_token;
                document.getElementById('visitorData').value = this.authConfig.visitor_data;
                document.getElementById('oauth2Token').value = this.authConfig.oauth2_token;

                // æ›´æ–°çŠ¶æ€
                this.updateAuthStatus(data);
            }
        } catch (error) {
            console.error('åŠ è½½è®¤è¯é…ç½®å¤±è´¥:', error);
        }
    }

    async saveAuthConfig() {
        try {
            const config = {
                po_token: document.getElementById('poToken').value.trim(),
                visitor_data: document.getElementById('visitorData').value.trim(),
                oauth2_token: document.getElementById('oauth2Token').value.trim()
            };

            const response = await apiRequest('/cookies/api/youtube-auth/save', {
                method: 'POST',
                body: JSON.stringify(config)
            });

            const data = await response.json();

            if (data.success) {
                showNotification('YouTubeè®¤è¯é…ç½®å·²ä¿å­˜', 'success');
                this.authConfig = config;
                this.updateAuthStatus(data);
            } else {
                showNotification('ä¿å­˜å¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
        }
    }

    async testAuthConfig() {
        try {
            const response = await apiRequest('/cookies/api/youtube-auth/test', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showNotification('è®¤è¯é…ç½®æµ‹è¯•å®Œæˆ', 'success');
                this.showTestResults(data);
            } else {
                showNotification('æµ‹è¯•å¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            showNotification('æµ‹è¯•å¤±è´¥: ' + error.message, 'danger');
        }
    }

    async clearAuthConfig() {
        if (!confirm('ç¡®å®šè¦æ¸…é™¤YouTubeè®¤è¯é…ç½®å—ï¼Ÿ')) return;

        try {
            const response = await apiRequest('/cookies/api/youtube-auth/delete', {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showNotification('è®¤è¯é…ç½®å·²æ¸…é™¤', 'success');

                // æ¸…ç©ºè¡¨å•
                document.getElementById('poToken').value = '';
                document.getElementById('visitorData').value = '';
                document.getElementById('oauth2Token').value = '';

                // é‡ç½®é…ç½®
                this.authConfig = { po_token: '', visitor_data: '', oauth2_token: '' };
                this.updateAuthStatus({ po_token_available: false, visitor_data_available: false, oauth2_available: false });
            } else {
                showNotification('æ¸…é™¤å¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            showNotification('æ¸…é™¤å¤±è´¥: ' + error.message, 'danger');
        }
    }

    async autoGeneratePOToken() {
        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const autoGenerateBtn = document.getElementById('autoGenerateBtn');
            const originalText = autoGenerateBtn.innerHTML;
            autoGenerateBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>ç”Ÿæˆä¸­...';
            autoGenerateBtn.disabled = true;

            showNotification('æ­£åœ¨è‡ªåŠ¨ç”ŸæˆPO Tokenï¼Œè¯·ç¨å€™...', 'info');

            const response = await apiRequest('/cookies/api/youtube-auth/auto-generate', {
                method: 'POST',
                body: JSON.stringify({})
            });

            const data = await response.json();

            if (data.success) {
                // è‡ªåŠ¨å¡«å…¥è¡¨å•
                if (data.po_token) {
                    document.getElementById('poToken').value = data.po_token;
                    this.authConfig.po_token = data.po_token;
                }
                if (data.visitor_data) {
                    document.getElementById('visitorData').value = data.visitor_data;
                    this.authConfig.visitor_data = data.visitor_data;
                }

                // è‡ªåŠ¨ä¿å­˜é…ç½®
                await this.saveAuthConfig();

                showNotification('PO Tokenè‡ªåŠ¨ç”ŸæˆæˆåŠŸï¼å·²è‡ªåŠ¨ä¿å­˜é…ç½®', 'success');

                // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
                await this.loadAuthConfig();
            } else {
                showNotification('è‡ªåŠ¨ç”Ÿæˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }

        } catch (error) {
            console.error('è‡ªåŠ¨ç”Ÿæˆé”™è¯¯:', error);
            showNotification('è‡ªåŠ¨ç”Ÿæˆå¤±è´¥: ' + error.message, 'danger');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const autoGenerateBtn = document.getElementById('autoGenerateBtn');
            autoGenerateBtn.innerHTML = '<i class="bi bi-magic me-1"></i>è‡ªåŠ¨è·å–';
            autoGenerateBtn.disabled = false;
        }
    }

    async showManualGuide() {
        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const manualGuideBtn = document.getElementById('manualGuideBtn');
            const originalText = manualGuideBtn.innerHTML;
            manualGuideBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>åŠ è½½ä¸­...';
            manualGuideBtn.disabled = true;

            showNotification('æ­£åœ¨è·å–PO Tokenæ‰‹åŠ¨è·å–æŒ‡å—...', 'info');

            const response = await apiRequest('/cookies/api/youtube-auth/auto-extract', {
                method: 'POST',
                body: JSON.stringify({})
            });

            const data = await response.json();

            if (data.success && data.guide) {
                this.showManualGuideModal(data.guide);
                showNotification('å·²æ˜¾ç¤ºæ‰‹åŠ¨è·å–æŒ‡å—', 'success');
            } else {
                showNotification('è·å–æŒ‡å—å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }

        } catch (error) {
            console.error('è·å–æŒ‡å—é”™è¯¯:', error);
            showNotification('è·å–æŒ‡å—å¤±è´¥: ' + error.message, 'danger');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const manualGuideBtn = document.getElementById('manualGuideBtn');
            manualGuideBtn.innerHTML = '<i class="bi bi-book me-1"></i>æ‰‹åŠ¨æŒ‡å—';
            manualGuideBtn.disabled = false;
        }
    }

    async showSetupDialog(method) {
        // æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†çš„å®ç°
        const modal = document.createElement('div');
        modal.className = 'modal fade';

        let setupContent = '';
        if (method === 'bgutil') {
            setupContent = `
                <p>BgUtils Provideræ˜¯å®˜æ–¹æ¨èçš„PO Tokenæä¾›å™¨ï¼Œæœ‰ä¸¤ç§å®‰è£…æ–¹å¼ï¼š</p>
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">ğŸ³ Dockeræ–¹å¼ (æ¨è)</h6>
                                <p class="card-text">æœ€ç®€å•çš„å®‰è£…æ–¹å¼ï¼Œä¸€é”®å¯åŠ¨ï¼š</p>
                                <code>docker run -d -p 4416:4416 --name bgutil-provider brainicism/bgutil-ytdlp-pot-provider</code>
                                <div class="mt-2">
                                    <button class="btn btn-primary btn-sm setup-method-btn" data-method="bgutil" data-type="docker">
                                        <i class="bi bi-play me-1"></i>ä½¿ç”¨Dockerå®‰è£…
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">ğŸ”§ åŸç”Ÿæ–¹å¼</h6>
                                <p class="card-text">éœ€è¦Node.jså’ŒYarnç¯å¢ƒï¼š</p>
                                <ol class="small">
                                    <li>å®‰è£…Node.js (>=18) å’Œ Yarn</li>
                                    <li>å…‹éš†ä»“åº“å¹¶æ„å»º</li>
                                    <li>å¯åŠ¨æœåŠ¡å™¨</li>
                                </ol>
                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm setup-method-btn" data-method="bgutil" data-type="native">
                                        <i class="bi bi-gear me-1"></i>ä½¿ç”¨åŸç”Ÿå®‰è£…
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (method === 'selenium') {
            setupContent = `
                <p>Seleniuméœ€è¦å®‰è£…æµè§ˆå™¨é©±åŠ¨ï¼š</p>
                <div class="alert alert-info">
                    <h6>å®‰è£…æ­¥éª¤ï¼š</h6>
                    <ol>
                        <li>å®‰è£…Selenium: <code>pip install selenium</code></li>
                        <li>ä¸‹è½½å¯¹åº”çš„æµè§ˆå™¨é©±åŠ¨</li>
                        <li>ç¡®ä¿é©±åŠ¨åœ¨PATHä¸­</li>
                    </ol>
                </div>
                <button class="btn btn-primary setup-method-btn" data-method="selenium" data-type="install">
                    <i class="bi bi-download me-1"></i>å®‰è£…Selenium
                </button>
            `;
        }

        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content modern-card">
                    <div class="modal-header">
                        <h5 class="modal-title">è®¾ç½® ${method} æ–¹æ³•</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${setupContent}
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        modal.addEventListener('click', async (e) => {
            if (e.target.classList.contains('setup-method-btn')) {
                const method = e.target.dataset.method;
                const type = e.target.dataset.type;

                bsModal.hide();
                await this.executeSetup(method, type);
            }
        });

        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    }

    async executeSetup(method, type) {
        try {
            showNotification(`æ­£åœ¨è®¾ç½®${method}æ–¹æ³•...`, 'info');

            const response = await apiRequest('/cookies/api/youtube-auth/setup', {
                method: 'POST',
                body: JSON.stringify({
                    method: method,
                    method: type  // docker, native, install
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`${method}è®¾ç½®æˆåŠŸï¼`, 'success');
            } else {
                showNotification(`${method}è®¾ç½®å¤±è´¥: ${data.error}`, 'danger');
            }
        } catch (error) {
            showNotification(`è®¾ç½®å¤±è´¥: ${error.message}`, 'danger');
        }
    }

    showManualGuideModal(guide) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content modern-card">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-book me-2"></i>${guide.title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- è‡ªåŠ¨ç”Ÿæˆæ–¹æ³• -->
                        <div class="card border-success mb-4">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">${guide.auto_method.title}</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${guide.auto_method.description}</p>

                                <h6 class="text-primary">ğŸ“‹ è¦æ±‚ï¼š</h6>
                                <ul class="list-group list-group-flush mb-3">
                                    ${guide.auto_method.requirements.map(req => `
                                        <li class="list-group-item">${req}</li>
                                    `).join('')}
                                </ul>

                                <h6 class="text-primary">ğŸ’» ä»£ç ç¤ºä¾‹ï¼š</h6>
                                <pre class="bg-light p-3 rounded"><code>${guide.auto_method.code_example}</code></pre>

                                <h6 class="text-success">âœ… ä¼˜åŠ¿ï¼š</h6>
                                <ul class="list-group list-group-flush mb-3">
                                    ${guide.auto_method.advantages.map(adv => `
                                        <li class="list-group-item">${adv}</li>
                                    `).join('')}
                                </ul>

                                <h6 class="text-warning">âš ï¸ é™åˆ¶ï¼š</h6>
                                <ul class="list-group list-group-flush">
                                    ${guide.auto_method.limitations.map(limit => `
                                        <li class="list-group-item">${limit}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- Node.js å®‰è£…æŒ‡å— -->
                        <div class="card border-info mb-4">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">${guide.nodejs_install.title}</h6>
                            </div>
                            <div class="card-body">
                                <ol class="list-group list-group-numbered">
                                    ${guide.nodejs_install.steps.map(step => `
                                        <li class="list-group-item">${step}</li>
                                    `).join('')}
                                </ol>
                            </div>
                        </div>

                        <!-- æ‰‹åŠ¨è·å–æ–¹æ³• -->
                        <div class="card border-warning mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">${guide.manual_method.title}</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${guide.manual_method.description}</p>

                                <h6 class="text-primary">ğŸ“‹ è¯¦ç»†æ­¥éª¤ï¼š</h6>
                                <ol class="list-group list-group-numbered mb-3">
                                    ${guide.manual_method.steps.map(step => `
                                        <li class="list-group-item">${step}</li>
                                    `).join('')}
                                </ol>

                                <div class="alert alert-warning">
                                    <h6 class="text-warning">âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹ï¼š</h6>
                                    <ul class="mb-0">
                                        ${guide.manual_method.important_notes.map(note => `
                                            <li>${note}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- ä»£ç†ç¯å¢ƒç‰¹åˆ«è¯´æ˜ -->
                        <div class="card border-danger mb-4">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">${guide.proxy_environment.title}</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${guide.proxy_environment.description}</p>

                                <h6 class="text-danger">âŒ å·²çŸ¥é—®é¢˜ï¼š</h6>
                                <ul class="list-group list-group-flush mb-3">
                                    ${guide.proxy_environment.issues.map(issue => `
                                        <li class="list-group-item">${issue}</li>
                                    `).join('')}
                                </ul>

                                <h6 class="text-success">âœ… è§£å†³æ–¹æ¡ˆï¼š</h6>
                                <ul class="list-group list-group-flush mb-3">
                                    ${guide.proxy_environment.solutions.map(solution => `
                                        <li class="list-group-item">${solution}</li>
                                    `).join('')}
                                </ul>

                                <h6 class="text-primary">ğŸ“‹ æ¨èå·¥ä½œæµç¨‹ï¼š</h6>
                                <ol class="list-group list-group-numbered">
                                    ${guide.proxy_environment.workflow.map(step => `
                                        <li class="list-group-item">${step}</li>
                                    `).join('')}
                                </ol>
                            </div>
                        </div>

                        <!-- é€šç”¨æç¤º -->
                        <div class="alert alert-info">
                            <h6 class="text-info">ğŸ’¡ é€šç”¨æç¤ºï¼š</h6>
                            <ul class="mb-0">
                                ${guide.tips.map(tip => `
                                    <li>${tip}</li>
                                `).join('')}
                            </ul>
                        </div>

                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>ä»£ç†é…ç½®ï¼š</strong>ç¡®ä¿æ‚¨å·²åœ¨è®¾ç½®é¡µé¢é…ç½®äº†ä»£ç†ï¼Œè¿™æ ·è·å–çš„PO Tokenæ‰èƒ½åœ¨ä¸‹è½½æ—¶æ­£å¸¸ä½¿ç”¨ã€‚
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        <button type="button" class="btn btn-info" onclick="window.open('https://nodejs.org/', '_blank')">
                            <i class="bi bi-download me-1"></i>ä¸‹è½½ Node.js
                        </button>
                        <button type="button" class="btn btn-warning" onclick="window.open('https://www.youtube.com/embed/aqz-KE-bpKQ', '_blank')">
                            <i class="bi bi-youtube me-1"></i>æ‰“å¼€ YouTube Embedded
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    }



    updateAuthStatus(data) {
        const badge = document.getElementById('authStatusBadge');
        const statusCards = document.getElementById('authStatusCards');

        const hasPoToken = data.po_token_available;
        const hasVisitorData = data.visitor_data_available;
        const hasOAuth2 = data.oauth2_available;

        // æ›´æ–°çŠ¶æ€å¾½ç« 
        if (hasPoToken && hasVisitorData) {
            badge.textContent = 'å·²é…ç½®';
            badge.style.background = 'var(--gradient-success)';
        } else if (hasPoToken || hasVisitorData) {
            badge.textContent = 'éƒ¨åˆ†é…ç½®';
            badge.style.background = 'var(--gradient-warning)';
        } else {
            badge.textContent = 'æœªé…ç½®';
            badge.style.background = 'var(--gradient-danger)';
        }

        // æ›´æ–°çŠ¶æ€å¡ç‰‡
        statusCards.innerHTML = `
            <div class="col-md-4">
                <div class="card h-100 text-center" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                    <div class="card-body">
                        <i class="bi bi-key fs-1 ${hasPoToken ? 'text-success' : 'text-muted'}"></i>
                        <h6 class="card-title mt-2">PO Token</h6>
                        <p class="card-text">${hasPoToken ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 text-center" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                    <div class="card-body">
                        <i class="bi bi-person-badge fs-1 ${hasVisitorData ? 'text-success' : 'text-muted'}"></i>
                        <h6 class="card-title mt-2">Visitor Data</h6>
                        <p class="card-text">${hasVisitorData ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 text-center" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                    <div class="card-body">
                        <i class="bi bi-shield-check fs-1 ${hasOAuth2 ? 'text-success' : 'text-muted'}"></i>
                        <h6 class="card-title mt-2">OAuth2 Token</h6>
                        <p class="card-text">${hasOAuth2 ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
                    </div>
                </div>
            </div>
        `;

        // æ›´æ–°PO Tokenè¯¦ç»†ä¿¡æ¯
        this.updatePOTokenDetails(data);
    }

    updatePOTokenDetails(data) {
        const detailsContainer = document.getElementById('poTokenDetails');

        if (data.po_token_available || data.visitor_data_available) {
            // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            detailsContainer.style.display = 'block';

            // æ›´æ–°ç”Ÿæˆæ—¶é—´
            const generatedTime = data.generated_time || data.timestamp;
            if (generatedTime) {
                const date = new Date(generatedTime * 1000);
                document.getElementById('poTokenGeneratedTime').textContent = date.toLocaleString();
            } else {
                document.getElementById('poTokenGeneratedTime').textContent = 'æœªçŸ¥';
            }

            // æ›´æ–°æœ€åéªŒè¯æ—¶é—´
            const lastValidated = data.last_validated;
            if (lastValidated) {
                const date = new Date(lastValidated * 1000);
                document.getElementById('poTokenLastValidated').textContent = date.toLocaleString();
            } else {
                document.getElementById('poTokenLastValidated').textContent = 'æœªéªŒè¯';
            }

            // æ›´æ–°çŠ¶æ€
            const statusElement = document.getElementById('poTokenStatus');
            if (data.po_token_available && data.visitor_data_available) {
                statusElement.innerHTML = '<span class="badge bg-success">å®Œæ•´é…ç½®</span>';
            } else if (data.po_token_available || data.visitor_data_available) {
                statusElement.innerHTML = '<span class="badge bg-warning">éƒ¨åˆ†é…ç½®</span>';
            } else {
                statusElement.innerHTML = '<span class="badge bg-secondary">æœªé…ç½®</span>';
            }

            // æ›´æ–°æ¥æº
            const source = data.source || 'æ‰‹åŠ¨é…ç½®';
            document.getElementById('poTokenSource').textContent = source;

        } else {
            // éšè—è¯¦ç»†ä¿¡æ¯
            detailsContainer.style.display = 'none';
        }
    }

    showTestResults(data) {
        if (data.details) {
            let message = 'æµ‹è¯•ç»“æœ:\n';
            Object.keys(data.details).forEach(key => {
                const config = data.details[key];
                const name = key === 'po_token' ? 'PO Token' :
                           key === 'visitor_data' ? 'Visitor Data' : 'OAuth2 Token';
                message += `${name}: ${config.available ? 'âœ“ å·²é…ç½®' : 'âœ— æœªé…ç½®'}\n`;
            });

            if (data.recommendation && data.recommendation.length > 0) {
                message += '\nå»ºè®®:\n' + data.recommendation.join('\n');
            }

            alert(message);
        }
    }
}

// åˆå§‹åŒ–åº”ç”¨
let app;
document.addEventListener('DOMContentLoaded', () => {
    app = new CookiesApp();
});
</script>
{% endblock %}
