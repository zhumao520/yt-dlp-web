{% extends "base_modern.html" %}
{% set hide_nav = true %}

{% block title %}ç™»å½• - YT-DLP Web ç°ä»£åŒ–è§†é¢‘ä¸‹è½½å¹³å°{% endblock %}

{% block content %}
<div class="min-vh-100 d-flex align-items-center justify-content-center py-5"
     style="background: transparent;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">

                <!-- ğŸ¨ ç°ä»£åŒ–å¤´éƒ¨ -->
                <div class="text-center mb-5 animate-fade-in-up">
                    <div class="mb-4">
                        <i class="bi bi-play-circle-fill display-3 text-white"></i>
                    </div>
                    <h1 class="h2 text-white fw-bold mb-2">YT-DLP Web</h1>
                    <p class="text-white opacity-75">ç°ä»£åŒ–è§†é¢‘ä¸‹è½½å¹³å°</p>
                </div>

                <!-- ğŸ¯ ç°ä»£åŒ–ç™»å½•è¡¨å• -->
                <div class="modern-card p-4 animate-fade-in-up" style="animation-delay: 0.2s; background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%) !important; backdrop-filter: blur(15px) !important; -webkit-backdrop-filter: blur(15px) !important;">
                    <div class="text-center mb-4">
                        <h3 class="fw-semibold mb-2">æ¬¢è¿å›æ¥</h3>
                        <p class="text-muted">è¯·ç™»å½•æ‚¨çš„è´¦æˆ·</p>
                    </div>
                    <form id="loginForm" x-data="loginManager()" x-on:submit.prevent="login()">

                        <!-- ğŸš¨ ç°ä»£åŒ–é”™è¯¯æç¤º -->
                        <div x-show="error" x-transition class="alert alert-danger border-0 rounded-3 mb-4">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            <span x-text="error"></span>
                        </div>

                        <!-- ğŸ‘¤ ç”¨æˆ·åè¾“å…¥ -->
                        <div class="mb-4">
                            <label for="username" class="form-label fw-semibold">
                                <i class="bi bi-person me-1 text-primary"></i>ç”¨æˆ·å
                            </label>
                            <input type="text"
                                   class="form-control modern-input form-control-lg"
                                   id="username"
                                   x-model="form.username"
                                   placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                                   autocomplete="username"
                                   required>
                        </div>

                        <!-- ğŸ”’ å¯†ç è¾“å…¥ -->
                        <div class="mb-4">
                            <label for="password" class="form-label fw-semibold">
                                <i class="bi bi-lock me-1 text-primary"></i>å¯†ç 
                            </label>
                            <div class="input-group input-group-lg">
                                <input :type="showPassword ? 'text' : 'password'"
                                       class="form-control modern-input"
                                       id="password"
                                       x-model="form.password"
                                       placeholder="è¯·è¾“å…¥å¯†ç "
                                       autocomplete="current-password"
                                       required>
                                <button type="button"
                                        class="btn btn-outline-secondary modern-btn"
                                        x-on:click="showPassword = !showPassword"
                                        title="æ˜¾ç¤º/éšè—å¯†ç ">
                                    <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                                </button>
                            </div>
                        </div>
                            
                        <!-- âœ… è®°ä½æˆ‘é€‰é¡¹ -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input type="checkbox"
                                       class="form-check-input"
                                       id="remember"
                                       x-model="form.remember">
                                <label class="form-check-label fw-medium" for="remember">
                                    <i class="bi bi-heart me-1 text-danger"></i>è®°ä½æˆ‘
                                </label>
                            </div>
                        </div>

                        <!-- ğŸš€ ç°ä»£åŒ–ç™»å½•æŒ‰é’® -->
                        <button type="submit"
                                class="btn btn-primary modern-btn w-100 py-3 fw-semibold"
                                :disabled="loading"
                                style="background: var(--gradient-primary); border: none; font-size: 1.1rem;">
                            <span x-show="!loading">
                                <i class="bi bi-box-arrow-in-right me-2"></i>ç™»å½•
                            </span>
                            <span x-show="loading">
                                <span class="spinner-border spinner-border-sm me-2"></span>ç™»å½•ä¸­...
                            </span>
                        </button>

                    </form>
                    </div>
                </div>
                
                <!-- ğŸŒŸ ç°ä»£åŒ–åº•éƒ¨ä¿¡æ¯ -->
                <div class="text-center mt-5 animate-fade-in-up" style="animation-delay: 0.4s;">
                    <div class="text-white opacity-75">
                        <p class="mb-2">
                            <i class="bi bi-shield-check me-1"></i>
                            å®‰å…¨ â€¢ å¿«é€Ÿ â€¢ ç°ä»£åŒ–
                        </p>
                        <p class="small">
                            <a href="https://github.com/yt-dlp/yt-dlp"
                               target="_blank"
                               class="text-white text-decoration-none opacity-75 hover-opacity-100">
                                <i class="bi bi-github me-1"></i>åŸºäº yt-dlp æ„å»º
                            </a>
                        </p>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ğŸ¯ Alpine.js ç™»å½•ç®¡ç†å™¨
function loginManager() {
    return {
        form: {
            username: '',
            password: '',
            remember: false
        },
        loading: false,
        showPassword: false,
        error: '',

        init() {
            this.checkExistingAuth();
        },
    
        async login() {
            this.loading = true;
            this.error = '';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.form)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    localStorage.setItem('auth_token', data.token);
                    showNotification('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');

                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    this.error = data.error || 'ç™»å½•å¤±è´¥';
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                this.error = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            } finally {
                this.loading = false;
            }
        },

        async checkExistingAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('logout') || urlParams.get('token_expired')) {
                return;
            }

            const cookieToken = this.getCookieToken();
            const localToken = localStorage.getItem('auth_token');
            const token = cookieToken || localToken;

            if (!token) {
                this.clearAllTokens();
                return;
            }

            try {
                const response = await fetch('/api/auth/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        if (!localToken && cookieToken) {
                            localStorage.setItem('auth_token', cookieToken);
                        }
                        window.location.href = '/';
                        return;
                    }
                }

                this.clearAllTokens();
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                this.clearAllTokens();
            }
        },

        getCookieToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'auth_token') {
                    return value;
                }
            }
            return null;
        },

        clearAllTokens() {
            localStorage.removeItem('auth_token');
            document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        }
    }
}
</script>
{% endblock %}
